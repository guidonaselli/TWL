# Daily Security Report - 2026-01-28

**Agent:** Jules
**Focus:** Economy Hardening & Bind/Unbind Policy Enforcement

## Summary
Addressed a critical security gap where the client-side/shared `Inventory` model merged items solely by ID, ignoring `BindPolicy`. This could allow players to stack "Bound" items with "Unbound" items, effectively laundering them. Hardened the `EconomyManager` to explicitly define and enforce bind policies for shop purchases, ensuring premium items (e.g., BindOnPickup) are correctly flagged upon acquisition.

## Changes Implemented

### 1. Shared Inventory Model Hardening (`TWL.Shared`)
*   **ItemSlot Refactor:** Added `BindPolicy` and `BoundToId` fields to `ItemSlot`.
*   **Inventory Logic:** Converted internal storage from `Dictionary<int, ItemSlot>` to `List<ItemSlot>`. Rewrote `AddItem` to only merge stacks if `BindPolicy` and `BoundToId` match exactly.

### 2. Economy Manager Hardening (`TWL.Server`)
*   **Shop Policy Definition:** Updated `_shopItems` mock database to include `BindPolicy` for each product.
*   **Purchase Enforcement:** Updated `BuyShopItem` to pass the configured policy to `ServerCharacter.AddItem`, ensuring items bought from the shop respect their intended restrictions (e.g., untradable).

### 3. Testing & Verification
*   Created `TWL.Tests/Security/EconomyBindPolicyTests.cs` with 7 new tests covering:
    *   **Inventory Separation:** Verifying Bound and Unbound items of the same ID occupy different slots.
    *   **Shop Policy:** Verifying purchased items receive the correct policy (BindOnPickup vs Unbound).
    *   **Trade Restrictions:** Verifying `TradeManager` prevents transfer of Bound items.
    *   **Idempotency:** Verifying repeated purchase requests with the same Operation ID are rejected/idempotent.

## Test Results
*   **EconomyBindPolicyTests:** 7/7 Passed.
*   **EconomyHardeningTests (Existing):** 4/4 Passed.
*   **Total Security Tests Run:** 11

## Next Steps
*   Extend `Inventory` refactor to `ServerCharacter` if deeper separation is needed (currently `ServerCharacter` logic was already robust, but relied on correct inputs).
*   Audit `LootManager` / `DropManager` to ensure mob drops also apply correct Bind Policies.

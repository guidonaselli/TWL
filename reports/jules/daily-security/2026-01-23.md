# Daily Security Report - 2026-01-23

## Domain: Item Mall & Premium Currency

### Amenaza
Manipulación de transacciones económicas, incluyendo "Double Spend" (gastar la misma moneda dos veces), "Replay Attacks" (reutilizar recibos de compra), y abuso de API (spam de intentos de compra).

### Vectores de Ataque
1. **Replay Attack**: Un atacante intercepta un paquete `PurchaseGemsVerify` válido y lo reenvía para duplicar la acreditación de gemas.
2. **Race Condition**: Un atacante envía múltiples solicitudes `BuyShopItem` simultáneamente para comprar más ítems de los que permite su saldo.
3. **Brute Force / Spam**: Intentos masivos de adivinar `OrderId` o saturar el servicio de verificación.

### Mitigación Implementada
1. **Idempotencia (Server-Authoritative)**:
   - Se rastrea el estado de cada transacción (`Pending` -> `Completed`) mediante `OrderId`.
   - Los intentos repetidos de verificar una transacción completada retornan éxito (para el cliente) pero **no** vuelven a acreditar moneda.

2. **Atomicidad y Concurrencia**:
   - Implementación de `TryConsumePremiumCurrency` en `ServerCharacter` utilizando `Interlocked.CompareExchange` (CAS loop) para garantizar que el saldo nunca sea negativo, incluso bajo alta concurrencia.

3. **Validación Estricta**:
   - Verificación de `UserId` contra la sesión.
   - Validación de existencia de productos e ítems.
   - Entradas negativas o cero rechazadas.

4. **Rate Limiting**:
   - Políticas estrictas añadidas a `RateLimiter`:
     - `PurchaseGemsIntent/Verify`: 1 cada 5 segundos (Capacity 2).
     - `BuyShopItem`: 1 por segundo (Capacity 5).

5. **Auditoría (Ledger)**:
   - Registro append-only en `economy_ledger.log` de todas las operaciones críticas con deltas y balances resultantes.

### Tests
Se han implementado pruebas unitarias en `TWL.Tests/Economy/EconomyTests.cs` verificando:
- **Flujo Exitoso**: Compra e ítem recibido.
- **Idempotencia**: `VerifyPurchase` repetido no duplica saldo.
- **User Mismatch**: Verificación con usuario incorrecto falla.
- **Fondos Insuficientes**: Compra rechazada sin cambios en saldo.
- **Concurrencia**: `BuyShopItem` paralelo no permite "double spend".

### Evidencia
Tests pasados exitosamente: `Passed: 5`.

# Daily Security Report - 2026-01-23

## Resumen
Se ha implementado un sistema de **Hardening** en la capa de red (`ClientSession`) para mitigar ataques de DoS y manipulación de paquetes.

## Amenazas Identificadas
1.  **Denial of Service (DoS):** Envío masivo de paquetes (`Opcode` flooding) para saturar el servidor.
2.  **Replay Attacks / Exploits:** Repetición de paquetes `ClaimRewardRequest` o `InteractRequest` para obtener beneficios ilegítimos.
3.  **Invalid Payloads:** Envío de strings malformados o excesivamente largos para causar excepciones o buffer overflows.

## Mitigaciones Implementadas

### 1. Rate Limiting (Token Bucket)
Se creó la clase `TWL.Server.Security.RateLimiter` que implementa un algoritmo de Token Bucket.
- **Login:** 3 peticiones/minuto.
- **Move:** 20 peticiones/segundo.
- **Attack/Interact:** 10 peticiones/segundo.
- **Quest Ops:** 3 peticiones/segundo.

Esto previene el spamming de acciones críticas.

### 2. Validación Estricta de Inputs
En `ClientSession.cs`, se agregaron validaciones antes de procesar la lógica de negocio:
- **Length Checks:** Rechazo inmediato de payloads > 256/512 bytes.
- **Quest IDs:** Validación de `questId > 0`.
- **TargetName:** Validación de `!string.IsNullOrWhiteSpace` y longitud máxima 64.
- **JSON Parsing:** Bloques `try/catch` para evitar crash por JSON inválido.

### 3. Security Logging
Se implementó `SecurityLogger` para registrar eventos de rechazo (RateLimitExceeded, InvalidInput) con `UserId` y `Opcode`.

## Tests
Se agregaron pruebas unitarias en `TWL.Tests/Security/RateLimiterTests.cs`:
- `Check_AllowsRequestsUnderLimit`: Verifica que el tráfico legítimo pasa.
- `Check_BlocksRequestsOverLimit`: Verifica que el exceso de tráfico se bloquea.
- `Check_RefillsOverTime`: Verifica la recuperación de tokens.

Estado de los tests: **PASS** (3/3 passed).

## Próximos Pasos
- Implementar validación de rango (distancia) en `InteractRequest`.
- Mover la configuración de Rate Limits a un archivo de configuración (`security.json`).
- Implementar "Circuit Breaker" para desconectar clientes que violan repetidamente las reglas de seguridad.

# Daily Security Report - 2026-02-07

**Agent:** Jules
**Focus:** Monetization Hardening (Bind/Unbind & Trade)

## Executive Summary
Addressed a critical vulnerability in the Item Trade system that allowed "Laundering" of Bound items (transforming a Bound item into an Unbound copy) by exploiting loose inventory removal logic. Implemented strict item removal and improved transaction atomicity.

## Vulnerabilities Addressed

### 1. Bind Laundering (Severity: High)
*   **Description:** The `TradeManager.TransferItem` method validated the *presence* of a transferable (unbound) item but used a generic `RemoveItem` method that could remove a *bound* item of the same ID if present in the inventory first.
*   **Exploit:** A player with 1 Bound Sword and 1 Unbound Sword could initiate a trade for 1 Sword. The validation would pass (seeing the Unbound one), but the removal logic might deduct the Bound one. The target would receive a new Unbound copy. Result: The Bound restriction is bypassed.
*   **Fix:** Introduced `ServerCharacter.RemoveItemExact` which enforces strict matching of `BindPolicy` and `BoundToId`. Updated `TradeManager` to use this method.

### 2. Transaction Rollback Reliability (Severity: Medium)
*   **Description:** Trade transactions relied heavily on rollbacks if the target inventory was full, which increases the window for race conditions or item loss/duplication if a rollback fails.
*   **Fix:** Added `ServerCharacter.CanAddItem` for optimistic pre-validation of target inventory space before removing items from the source.

## Technical Changes

*   **`TWL.Server/Simulation/Networking/ServerCharacter.cs`**:
    *   Added `RemoveItemExact(int itemId, int quantity, BindPolicy policy, int? boundToId)`.
    *   Added `CanAddItem(int itemId, int quantity, BindPolicy policy, int? boundToId)`.

*   **`TWL.Server/Simulation/Managers/TradeManager.cs`**:
    *   Updated `TransferItem` to use `RemoveItemExact` for both transfer and rollback operations.
    *   Added `CanAddItem` check.

## Verification

*   **New Test:** `TWL.Tests/Security/TradeBindLaunderingTests.cs`
    *   Scenario: Mixed inventory (Bound + Unbound). Trade 1 Unbound.
    *   Result: PASS (Confirmed Bound item remains, Unbound item is transferred).
*   **Regression Test:** `TWL.Tests/Security/TradeBindHardeningTests.cs`
    *   Result: PASS.

## Next Steps
*   Audit `CraftingService` or `ForgeService` for similar "loose removal" patterns where a player might consume bound materials in place of unbound ones (or vice versa depending on game rules).

# Daily Report: Pet System Core Implementation
Date: 2026-01-27
Author: Jules

## Objective
Implement the core Pet System for the JRPG server, adhering to WLO-like structures (Capture, Growth, Amity, Combat Integration) while ensuring clean architecture and server-side authority.

## Implemented Features

### 1. Architectural Refactor (`ServerCombatant`)
To support pets in combat alongside players, I refactored the combat entity hierarchy:
- **`ServerCombatant` (New Abstract Base)**: Encapsulates common combat logic (Stats, StatusEffects, Skills, Health/SP Management).
- **`ServerCharacter`**: Now inherits from `ServerCombatant`.
- **`ServerPet`**: Now inherits from `ServerCombatant`.
- **`CombatManager`**: Updated to operate on `ServerCombatant`, allowing seamlessly mixing Players and Pets in battle logic.

### 2. Pet Logic & Content
- **`ServerPet` Enhancements**:
  - Implemented `Hydrate` to link persisted data with definitions.
  - Implemented `RecalculateStats` using `PetGrowthCalculator`.
  - Added `Amity` mechanics (loss on death, gating skills).
  - Added `Rebirth` logic (stat bonus, reset level).
  - Added `Utility` value calculation.
- **Content**: Created `Content/Data/pets.json` with 5 sample pets (Wolf, Spirit, Knight, Riding Bird, Pigeon).

### 3. Service Integration
- **`PetService`**:
  - Implemented `CapturePet`, `SwitchPet`, `DismissPet`.
  - **SwitchPet Logic**: Handles unregistering the old pet from `CombatManager` and registering the new active pet with a unique Runtime ID (`-OwnerId`).
- **`ClientSession`**:
  - Updated to Hydrate pets on login.
  - Added handling for `Opcode.PetActionRequest`.

### 4. Testing
- Created `TWL.Tests/PetTests/PetSystemTests.cs`.
- Verified Capture, Growth, Combat Integration, and Amity logic.
- Verified pipeline reliability with `PipelineMetricsTests`.

## Technical Notes
- **Runtime ID Strategy**: Active pets in combat use `-OwnerId` as their combat ID to avoid collision with positive Player IDs. This assumes 1 active pet per player.
- **Serialization**: Updated `PetManager` to support JSON Field inclusion (`IncludeFields = true`) to correctly load `PetDefinition`.

## Next Steps
- Implement specific `PetUtility` mechanics in the world (e.g., Mount speed boost).
- Enhance UI feedback for Pet Amity changes.
- Implement "Quest Pet" expiry logic.

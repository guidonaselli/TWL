# Reliability Report - 2026-01-26

## Task: PERS-002 - Persistence Reliability & Observability

### Summary
Addressed reliability issues where changes to Pets and Skill Usage were not triggering a save (dirty flag propagation). Introduced structured logging for the persistence service.

### Changes
1.  **Observability**: Created `PersistenceLogger` to standardize log output for persistence events. Replaced raw `Console.WriteLine` in `PlayerService`.
2.  **Reliability**:
    *   Added `IsDirty` tracking to `ServerPet`.
    *   Updated `ServerCharacter.IsDirty` to verify `Pets.Any(p => p.IsDirty)`.
    *   Updated `ServerCharacter.IncrementSkillUsage` to set `IsDirty = true`.
    *   Updated `ServerCharacter` to clear pet dirty flags when its own flag is cleared.

### Evidence
*   **Tests**: Added `DirtyPropagationTests.cs` verifying that:
    *   `ServerCharacter.IsDirty` becomes `true` when a Pet gains Exp.
    *   `ServerCharacter.IsDirty` becomes `true` when a Skill is used.
    *   Clearing `ServerCharacter.IsDirty` also clears Pet dirty flags.
*   **Regression**: Passed existing `PersistenceTests` and `PlayerServiceReliabilityTests`.

### Metrics Added
New structured log events in `PersistenceLogger`:
*   `[PERSISTENCE] ... [Event:ServiceStart]`
*   `[PERSISTENCE] ... [Event:FlushComplete] ... | Count:X | Duration:Yms | Errors:Z`
*   `[PERSISTENCE] ... [Event:SaveError] ...`

### Next Steps
*   Consider monitoring `FlushLoopError` frequency.
*   Extend `IPlayerRepository` to be async to avoid blocking the thread pool during heavy load (currently simulated with `Thread.Sleep` in tests, but real impl might be synchronous file IO).

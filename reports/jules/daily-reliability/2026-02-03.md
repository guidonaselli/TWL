# Daily Reliability Report - 2026-02-03

## Summary
Implemented graceful shutdown and health checks to ensure reliability and observability.

## Deliverables
- **PERS-006**: Health checks + graceful shutdown (flush controlado).
- **Metric**: `ShutdownDuration` and `PlayersSavedOnShutdown`.
- **Test**: `TWL.Tests/Reliability/ShutdownTests.cs` (Passes).
- **Ops**: `HealthCheckService` producing `health.json`.

## Changes
1.  **ServerWorker**: Updated `StopAsync` to disconnect players gracefully, wait for buffers, and then stop services. Added metrics recording.
2.  **PlayerService**: Added `DisconnectAllAsync` to forcefully disconnect all active sessions with a reason. Made methods virtual for testing.
3.  **ClientSession**: Added `DisconnectAsync` to send `Disconnect` packet and close connection. Fixed duplicate `SendLoginError`.
4.  **DbService**: Added `CheckHealthAsync` for liveness probe.
5.  **Metrics**: Added shutdown duration and persistence count tracking.
6.  **Architecture**: Extracted `INetworkServer` for testability.

## Evidence
- `ShutdownTests` verifies that `StopAsync` triggers `DisconnectAllAsync` and `Stop` on services, and records metrics.
- Logs show "Disconnecting players..." and "Server stopped in Xms".

## Next Steps
- Implement `PERS-007` (Pipeline Metrics) - Partially done with existing metrics, need visualization or more granular stages if needed.
- Monitor `health.json` in production environment.

# Reporte Diario de Confiabilidad - 2026-01-23

**Agente:** Jules
**Foco:** Persistence & Reliability (Dirty flags + batch/interval flush)

## 1. Problema Identificado (Hipótesis)
**Riesgo:** Pérdida total de progreso de los jugadores ante un crash o reinicio del servidor.
**Estado Inicial:** El servidor mantenía el estado de los personajes (`ServerCharacter` y `PlayerQuestComponent`) únicamente en memoria. `DbService` existía pero con funcionalidad mínima y `PlayerService` estaba comentado/inactivo. Al desconectarse o reiniciar, se perdían nivel, oro, items y progreso de quests.

## 2. Medición / Instrumentación
Se verificó mediante análisis estático que `ClientSession` creaba una nueva instancia de `ServerCharacter` en cada login:
```csharp
Character = new ServerCharacter { Id = uid, Name = loginDto.Username, Hp = 100 };
```
No existía mecanismo de carga ni guardado.

## 3. Solución Implementada
Se implementó un sistema de persistencia basado en archivos JSON (Snapshots) con escritura atómica y flushing periódico (Dirty Flags).

### Componentes:
1.  **DTOs de Persistencia:** `PlayerSaveData`, `ServerCharacterData`, `QuestData` en `TWL.Server.Persistence`.
2.  **Repositorio:** `FilePlayerRepository` implementando `IPlayerRepository`. Guarda en `Data/Saves/{userId}.json` usando escritura atómica (tmp + move).
3.  **Domain Enhancements:**
    *   `ServerCharacter`: Se agregó propiedad `IsDirty` y métodos `GetSaveData`/`LoadSaveData` con locking apropiado.
    *   `PlayerQuestComponent`: Se agregó propiedad `IsDirty` y lógica de serialización.
4.  **Servicio de Persistencia (`PlayerService`):**
    *   Mantiene registro de sesiones activas.
    *   Tarea en segundo plano (Background Task) que ejecuta `FlushAllDirty()` cada 30 segundos.
    *   Guarda automáticamente al desconectar la sesión.
5.  **Integración:**
    *   `ClientSession` recupera datos al loguearse mediante `PlayerService.LoadData`.
    *   `GameServer` y `ServerWorker` gestionan el ciclo de vida de `PlayerService`.

## 4. Evidencia y Verificación
Se agregaron tests unitarios en `TWL.Tests/Persistence/PersistenceTests.cs` cubriendo:
*   Serialización y deserialización correcta de `ServerCharacter` (incluyendo inventario).
*   Funcionamiento de la bandera `IsDirty` ante cambios de estado (Oro, Items, Exp).
*   Escritura y lectura física del repositorio.

Resultados de tests:
```
Passed!  - Failed:     0, Passed:     3, Skipped:     0, Total:     3, Duration: 100 ms - TWL.Tests.dll (net8.0)
```
Total suite passing: 75 tests.

## 5. Próximos Pasos (Deuda Técnica)
*   Migrar `FilePlayerRepository` a `DbPlayerRepository` usando `DbService` (PostgreSQL) para producción.
*   Implementar validación de schema o versionado en los JSONs.

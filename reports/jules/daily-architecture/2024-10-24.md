# Daily Architecture Report: 2024-10-24

## Diagnostic
The `CombatManager` class was tightly coupled to the `SkillRegistry.Instance` singleton. This made it difficult to test combat logic in isolation, as tests relied on the global state and file I/O (loading `skills.json`). This violates the "Clean Domain" and "Testability" goals.

Additionally, `IEconomyService.BuyShopItem` interface was missing the `operationId` parameter which is crucial for idempotency, causing inconsistency between the contract and the implementation (`EconomyManager`).

## Proposed Solution (Surgical Change)
1.  **Extract Dependency**: Refactored `CombatManager` to accept `ISkillCatalog` via constructor injection.
2.  **Wire Dependency**: Updated `GameServer` to inject `SkillRegistry.Instance` (which implements `ISkillCatalog`) into `CombatManager`.
3.  **Update Tests**: Refactored `CombatManagerTests` to use a `MockSkillCatalog` instead of loading global JSON data. This ensures tests are fast, deterministic, and isolated.
4.  **Fix Contract**: Updated `IEconomyService` to match `EconomyManager`'s implementation of `BuyShopItem` including the optional `operationId`.

## Benefits
*   **Reduced Risk**: Combat logic is now decoupled from data loading.
*   **Improved Testability**: We can now write unit tests for `CombatManager` with arbitrary skill definitions without modifying external files.
*   **Contract Integrity**: Economy service interface now correctly exposes idempotency features.

## PR Content
*   `TWL.Server/Simulation/Managers/CombatManager.cs`: Injected `ISkillCatalog`.
*   `TWL.Server/Simulation/GameServer.cs`: Updated instantiation.
*   `TWL.Tests/Combat/CombatManagerTests.cs`: Updated to use Mock.
*   `TWL.Server/Simulation/Managers/IEconomyService.cs`: Updated signature.
*   Other tests updated to match constructor signature.

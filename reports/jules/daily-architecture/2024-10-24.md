# Daily Architecture Report - 2024-10-24

## Objective
Improve CORE Architecture & Code Quality by stabilizing contracts and reducing technical debt in testing.

## Changes Implemented

### 1. Contract Stabilization: `ICombatResolver`
- **Refactor**: Moved `ICombatResolver` from `TWL.Server.Simulation.Managers` to `TWL.Shared.Services`.
- **Interface Segregation**: Introduced `ICombatant` interface in `TWL.Shared.Domain.Battle` to decouple combat calculation from `ServerCombatant`.
- **Implementation**: Updated `ServerCombatant` to implement `ICombatant`. Updated `StandardCombatResolver` to use the shared interface.
- **Benefit**: `ICombatResolver` is now a pure domain service contract that can be shared with the client for prediction or simply to enforce cleaner boundaries.

### 2. Test Quality & Isolation
- **Problem**: Quest unit tests (`HiddenRuinsQuestTests`, `HiddenCoveTests`, `QuestRuinsExpansionTests`) were failing because they relied on production content (`Content/Data/quests.json`) which had drifted from test expectations.
- **Solution**: Created isolated test data (`TWL.Tests/Content/test_quests.json` and `test_interactions.json`) specifically for these unit tests.
- **Implementation**: Updated `TWL.Tests.csproj` to copy test content to output. Updated tests to load this isolated data.
- **Benefit**: Quest tests are now stable and decoupled from game content updates.

## Verification
- **Build**: Successful.
- **Tests**:
  - Fixed 8+ failing tests related to Quests and Combat.
  - `QuestCombatIntegrationTests` and `UseSkillHandlerTests` verified the new `ICombatResolver` contract works correctly.
  - Remaining failures (`EconomyTransactionTests`, `LocalizationAuditTests`) are pre-existing and tracked for future resolution.

## Next Steps
- Address `EconomyTransactionTests` idempotency failure (likely a logic issue in `EconomyManager` or test setup).
- Continue migrating Server-only contracts to Shared where appropriate (e.g., `IStatusEngine`).

# Daily Skills Report - 2026-01-24

## Design: Earth Skills (T1 + T2)

Implemented a coherent package of Earth skills covering Physical, Magical, and Support branches.

### Physical Branch
- **Rock Smash (ID 1001)**: T1. Basic single target damage. Scaling: Atk * 1.2.
- **Boulder Crush (ID 1002)**: T2. Heavy single target damage. Scaling: Atk * 1.8. Unlocks after Rock Smash Rank 10. Evolves from Rock Smash.

### Magical Branch
- **Stone Bullet (ID 1101)**: T1. Basic single target magic damage. Scaling: Mat * 1.2.
- **Rolling Stone (ID 1102)**: T2. Row damage. Scaling: Mat * 1.5. Unlocks after Stone Bullet Rank 10. Evolves from Stone Bullet.

### Support Branch
- **Gaia's Protection (ID 1201)**: T1. Buff Def. Scaling: Mdf * 0.5.
- **Entangle (ID 1202)**: T2. Seal/Control (Stop). Chance: 70%. Unlocks after Gaia's Protection Rank 10. Evolves from Gaia's Protection.

## Implementation Details

### Infrastructure
- **ServerCharacter**: Added `ConsumeSp` (atomic) and `CharacterElement` property.
- **SkillRegistry**: Added support for `StageUpgradeRules` deserialization.
- **StandardCombatResolver**: Refactored to use `SkillRegistry` for data-driven damage calculation (Scaling, Elemental Multipliers). Fixed Variance logic to include defense subtraction after scaling.
- **CombatManager**:
    - Added SP Validation and Consumption.
    - Added Skill Mastery progression (Rank up every 10 uses).
    - Added Skill Evolution logic (Replace skill when Rank Threshold reached).

### Tests
- **SkillEvolutionTests**: Verified Mastery increment, Evolution trigger, and SP consumption.
- **ServerEarthSkillTests**: Verified damage calculation for new Earth skills using actual JSON data.
- **CombatManagerTests**: Updated to support data-driven combat (mocking skills).
- **QuestCombatIntegrationTests**: Updated to support data-driven combat.

## Blockers / Learnings
- **SkillRegistry JSON Mapping**: `StageUpgradeRules` was missing from the DTO, causing evolution to fail silently initially.
- **Legacy Tests**: Many tests assumed hardcoded/legacy combat logic (`Str * 2`) ignoring defense. Updated tests to reflect the new robust formula `(ScaledValue * Element * Variance) - Defense`.
- **ServerCharacter vs Character**: `ServerCharacter` shadowed `Sp` property, requiring a custom `ConsumeSp` implementation.
- **Dependencies**: `Moq` was not available, implemented `MockRandomService` updates manually.

## Next Steps
- Implement T3 Skills (Earthquake, Meteor Strike, Petrify).
- Expand to other Elements (Water, Fire, Wind).
- Implement "Assistant/Support" specific mechanics (e.g. detailed Buff/Debuff system integration in Server, currently `CombatManager` relies on `BattleInstance` or needs to handle effects more explicitly if `BattleInstance` is client-side only).

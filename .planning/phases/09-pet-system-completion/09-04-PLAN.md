---
phase: 09-pet-system-completion
plan: 04
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - TWL.Shared/Domain/Requests/PetActionRequest.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Services/PetService.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Client/Presentation/Managers/GameClientManager.cs
  - TWL.Client/Presentation/Scenes/SceneGameplay.cs
  - TWL.Tests/PetTests/PetRidingSystemTests.cs
  - TWL.Tests/PetTests/PetActionUtilityHandlerTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can trigger riding utility through pet action request flow"
    - "Mount state applies an actual movement speed bonus during gameplay movement updates"
    - "Client receives and reflects mount/riding state from server-authoritative responses"
  artifacts:
    - path: "TWL.Server/Simulation/Networking/ClientSession.cs"
      provides: "Pet action utility handling path for mount and related pet utilities"
      contains: "PetActionType.Utility"
    - path: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      provides: "Mounted-state movement modifier applied in character movement logic"
      contains: "MoveSpeedModifier"
    - path: "TWL.Tests/PetTests/PetRidingSystemTests.cs"
      provides: "Regression tests for mount toggling and effective speed change"
      contains: "PetRidingSystemTests"
  key_links:
    - from: "TWL.Shared/Domain/Requests/PetActionRequest.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "utility-specific payload fields are parsed and routed to pet service"
      pattern: "AdditionalData|Utility"
    - from: "TWL.Server/Services/PetService.cs"
      to: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      via: "mount state outcome is returned and consumed by client-side state manager"
      pattern: "PetActionResponse"
---

<objective>
Implement end-to-end riding system flow for PET-07.

Purpose: Close the current utility/riding gap by connecting request handling, mount-state effects, and client-visible movement behavior.
Output: Utility action routing, riding movement integration, and riding behavior regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pet-system-completion/09-RESEARCH.md
@.planning/phases/09-pet-system-completion/09-03-PLAN.md

@TWL.Shared/Domain/Requests/PetActionRequest.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Services/PetService.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete utility request contract and server routing</name>
  <files>
    TWL.Shared/Domain/Requests/PetActionRequest.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Services/PetService.cs
  </files>
  <action>
    1. Extend `PetActionRequest` utility payload shape for explicit utility type/arguments.

    2. Implement `PetActionType.Utility` handler in `ClientSession` and route mount requests to `PetService.UseUtility`.

    3. Return structured response fields needed by client to reflect mounted state and resulting modifier.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Riding utility is server-reachable through the canonical pet action network path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply mounted speed bonus in gameplay movement flow</name>
  <files>
    TWL.Server/Simulation/Networking/ServerCharacter.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Client/Presentation/Scenes/SceneGameplay.cs
  </files>
  <action>
    1. Ensure server movement handling applies `MoveSpeedModifier` when character is mounted.

    2. Keep movement delta behavior bounded to avoid mount speed exploits and preserve predictable movement physics.

    3. Reflect mount-aware movement behavior in client gameplay update flow so users experience speed bonus.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Client/TWL.Client.csproj` succeed.
  </verify>
  <done>
    PET-07 speed bonus is observable and enforced by server-authoritative movement handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add riding and utility handler regression tests</name>
  <files>
    TWL.Tests/PetTests/PetActionUtilityHandlerTests.cs
    TWL.Tests/PetTests/PetRidingSystemTests.cs
    TWL.Client/Presentation/Managers/GameClientManager.cs
  </files>
  <action>
    1. Add tests validating utility request parsing and dispatch for mount operations.

    2. Add riding tests proving mounted/unmounted toggles and movement-speed delta behavior.

    3. Add client manager tests verifying mount response handling updates local gameplay state appropriately.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetActionUtilityHandlerTests|FullyQualifiedName~PetRidingSystemTests"`
  </verify>
  <done>
    Riding and utility routing behavior is regression-protected across server and client integration points.
  </done>
</task>

</tasks>

<verification>
- [ ] Utility pet action route is implemented in `ClientSession`
- [ ] Mounted state produces real movement speed change
- [ ] Client reflects riding state from server response
- [ ] Riding/utility tests pass
</verification>

<success_criteria>
- PET-07 is completed end-to-end with server-authoritative riding behavior
- Riding no longer exists as dormant service-only logic
</success_criteria>

<output>
After completion, create `.planning/phases/09-pet-system-completion/09-04-SUMMARY.md`
</output>

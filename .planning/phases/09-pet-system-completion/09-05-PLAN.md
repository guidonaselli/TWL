---
phase: 09-pet-system-completion
plan: 05
type: execute
wave: 4
depends_on: ["09-01", "09-02", "09-03", "09-04"]
files_modified:
  - TWL.Tests/PetTests/PetPhaseAcceptanceTests.cs
  - TWL.Tests/PetTests/PetClientServerIntegrationTests.cs
  - TWL.Tests/ContentIntegrationTests.cs
  - TWL.Tests/Server/QuestCombatIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "All Phase 9 requirements (PET-01, PET-02, PET-05, PET-06, PET-07) are encoded in repeatable acceptance tests"
    - "Pet AI, roster content, bonding behavior, and riding flow work together without cross-system regressions"
    - "Pet systems remain compatible with quest/combat integration pathways"
  artifacts:
    - path: "TWL.Tests/PetTests/PetPhaseAcceptanceTests.cs"
      provides: "Phase-level acceptance suite mapping each PET requirement to executable checks"
      contains: "PetPhaseAcceptanceTests"
    - path: "TWL.Tests/PetTests/PetClientServerIntegrationTests.cs"
      provides: "End-to-end client/server contract checks for pet actions and updates"
      contains: "PetClientServerIntegrationTests"
    - path: "TWL.Tests/Server/QuestCombatIntegrationTests.cs"
      provides: "Cross-system integration checks for pet behavior in combat/quest flow"
      contains: "QuestCombatIntegrationTests"
  key_links:
    - from: "TWL.Tests/PetTests/PetClientServerIntegrationTests.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "pet action requests and responses are validated over network contract path"
      pattern: "PetActionRequest|PetActionResponse"
    - from: "TWL.Tests/PetTests/PetPhaseAcceptanceTests.cs"
      to: "Content/Data/pets.json"
      via: "acceptance suite asserts roster and behavior requirements against real content"
      pattern: "PET-02"
---

<objective>
Finalize Phase 9 with acceptance-grade verification across all PET requirements.

Purpose: Ensure pet systems are execution-ready and stable across AI, content, bonding, and riding flows.
Output: Phase-level acceptance suite and client/server integration tests with cross-system regression coverage.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pet-system-completion/09-RESEARCH.md
@.planning/phases/09-pet-system-completion/09-01-PLAN.md
@.planning/phases/09-pet-system-completion/09-02-PLAN.md
@.planning/phases/09-pet-system-completion/09-03-PLAN.md
@.planning/phases/09-pet-system-completion/09-04-PLAN.md

@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Simulation/Managers/CombatManager.cs
@Content/Data/pets.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build phase acceptance suite mapping PET-01/02/05/06/07</name>
  <files>
    TWL.Tests/PetTests/PetPhaseAcceptanceTests.cs
    TWL.Tests/ContentIntegrationTests.cs
  </files>
  <action>
    1. Add a single acceptance suite with test cases explicitly labeled and mapped to PET-01, PET-02, PET-05, PET-06, PET-07.

    2. Reuse real content and server behavior entry points to avoid synthetic false positives.

    3. Keep failures diagnostic so unmet requirement scope is immediately obvious.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetPhaseAcceptanceTests"`
  </verify>
  <done>
    Phase requirements are directly test-addressable and auditable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client/server integration tests for pet action and riding flow</name>
  <files>
    TWL.Tests/PetTests/PetClientServerIntegrationTests.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Add integration tests for pet action request handling (switch, utility mount, dismiss) and response propagation.

    2. Assert riding state and movement modifier outcomes are preserved through request lifecycle.

    3. Validate duplicate or malformed utility requests fail safely.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetClientServerIntegrationTests"`
  </verify>
  <done>
    Pet network contract behavior is verified beyond unit-level checks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cross-system pet regressions in quest/combat integration suite</name>
  <files>
    TWL.Tests/Server/QuestCombatIntegrationTests.cs
    TWL.Tests/PetTests/PetPhaseAcceptanceTests.cs
  </files>
  <action>
    1. Add/extend integration checks ensuring pet AI and KO/amity flow do not regress quest or combat pipelines.

    2. Validate pet-side behavior remains compatible with existing encounter and quest update events.

    3. Keep regressions focused on multi-system interaction, not duplicate unit-test behavior.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~QuestCombatIntegrationTests|FullyQualifiedName~PetPhaseAcceptanceTests"`
  </verify>
  <done>
    Phase 9 is protected by realistic cross-system regression coverage.
  </done>
</task>

</tasks>

<verification>
- [ ] PET-01/02/05/06/07 each has explicit acceptance test coverage
- [ ] Client/server pet action contracts pass integration tests
- [ ] Quest/combat integration remains stable with pet systems enabled
- [ ] Phase acceptance suite passes
</verification>

<success_criteria>
- Phase 9 is execution-ready with requirement-complete verification coverage
- Pet systems are validated as integrated gameplay features, not isolated modules
</success_criteria>

<output>
After completion, create `.planning/phases/09-pet-system-completion/09-05-SUMMARY.md`
</output>

---
phase: 09-pet-system-completion
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - TWL.Shared/Domain/Characters/PetDefinition.cs
  - TWL.Server/Simulation/Networking/ServerPet.cs
  - TWL.Server/Services/PetService.cs
  - TWL.Tests/PetTests/PetBondingMechanicsTests.cs
  - TWL.Tests/PetTests/PetAmityKoTests.cs
autonomous: true

must_haves:
  truths:
    - "Pet amity decreases by exactly 1 on KO/death combat event"
    - "Bonding thresholds grant measurable pet benefits (stat bonuses and/or unlock behavior) as amity rises"
    - "Bonding effects are deterministic and bounded to prevent runaway scaling"
  artifacts:
    - path: "TWL.Server/Simulation/Networking/ServerPet.cs"
      provides: "Canonical amity and bond-tier effect calculation"
      contains: "ChangeAmity"
    - path: "TWL.Shared/Domain/Characters/PetDefinition.cs"
      provides: "Bonding metadata structure for content-driven bond behavior"
      contains: "Bond"
    - path: "TWL.Tests/PetTests/PetBondingMechanicsTests.cs"
      provides: "Regression coverage for bond-tier benefit behavior"
      contains: "PetBondingMechanicsTests"
  key_links:
    - from: "TWL.Server/Services/PetService.cs"
      to: "TWL.Server/Simulation/Networking/ServerPet.cs"
      via: "combat and utility amity changes route through server-pet bond recalculation"
      pattern: "ChangeAmity"
    - from: "TWL.Shared/Domain/Characters/PetDefinition.cs"
      to: "TWL.Server/Simulation/Networking/ServerPet.cs"
      via: "definition-provided bond configuration informs runtime stat/ability outcomes"
      pattern: "Bond"
---

<objective>
Complete PET-05 and PET-06 by formalizing amity KO impact and bond-tier rewards.

Purpose: Make amity and bonding systems explicit, tunable, and test-verified rather than incidental side effects.
Output: Bond metadata model updates, runtime bond mechanics, and focused amity/bonding regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pet-system-completion/09-RESEARCH.md
@.planning/phases/09-pet-system-completion/09-01-PLAN.md

@TWL.Server/Simulation/Networking/ServerPet.cs
@TWL.Server/Services/PetService.cs
@TWL.Shared/Domain/Characters/PetDefinition.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explicit bonding metadata and threshold model</name>
  <files>
    TWL.Shared/Domain/Characters/PetDefinition.cs
    TWL.Server/Simulation/Networking/ServerPet.cs
  </files>
  <action>
    1. Extend pet definition model with explicit bond-tier metadata (threshold + effect semantics).

    2. Implement runtime bond-tier evaluation in `ServerPet` so amity transitions produce deterministic effect updates.

    3. Keep backward compatibility for definitions that do not yet define advanced bond tiers.
  </action>
  <verify>
    `dotnet build TWL.Shared/TWL.Shared.csproj` and `dotnet build TWL.Server/TWL.Server.csproj` succeed.
  </verify>
  <done>
    Bonding behavior is definition-driven and no longer implicit-only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure KO amity decrement and bonding updates flow through service path</name>
  <files>
    TWL.Server/Services/PetService.cs
    TWL.Server/Simulation/Networking/ServerPet.cs
  </files>
  <action>
    1. Verify and harden KO/death event handling to guarantee a single amity decrement per KO event.

    2. Ensure amity change and bond-tier recalculation are triggered consistently from service-managed events.

    3. Add guardrails preventing duplicate death-trigger amity deductions from repeated event callbacks.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    PET-05 KO amity behavior is robust and consistent under repeated event pressure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add amity KO and bond-tier mechanics tests</name>
  <files>
    TWL.Tests/PetTests/PetAmityKoTests.cs
    TWL.Tests/PetTests/PetBondingMechanicsTests.cs
  </files>
  <action>
    1. Add tests proving KO/death reduces amity by exactly 1 from valid starting values.

    2. Add tests proving defined bond tiers grant expected stat/ability outcomes at threshold transitions.

    3. Add bounds tests to ensure bonding effects remain capped and reversible when amity drops.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetAmityKoTests|FullyQualifiedName~PetBondingMechanicsTests"`
  </verify>
  <done>
    PET-05 and PET-06 are covered by deterministic behavioral tests.
  </done>
</task>

</tasks>

<verification>
- [ ] KO/death amity decrement is exactly -1 per event
- [ ] Bond-tier rewards are definition-driven and deterministic
- [ ] Bonding effects are bounded and regression-tested
- [ ] Amity/bonding tests pass
</verification>

<success_criteria>
- PET-05 is explicitly enforced in combat event flow
- PET-06 provides clear and test-backed bonding rewards
</success_criteria>

<output>
After completion, create `.planning/phases/09-pet-system-completion/09-03-SUMMARY.md`
</output>

---
phase: 09-pet-system-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/PetBattlePolicy.cs
  - TWL.Server/Simulation/Managers/AutoBattleManager.cs
  - TWL.Server/Simulation/Managers/CombatManager.cs
  - TWL.Tests/PetTests/PetCombatAiTests.cs
autonomous: true

must_haves:
  truths:
    - "Pet combat AI chooses actions based on ally HP, party status effects, and elemental advantage rather than random targeting"
    - "Pet AI behavior is deterministic for equivalent combat state inputs"
    - "Pet AI decisions remain server-authoritative within combat turn flow"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/PetBattlePolicy.cs"
      provides: "Pet-specific decision heuristics and tunable thresholds"
      contains: "class PetBattlePolicy"
    - path: "TWL.Server/Simulation/Managers/AutoBattleManager.cs"
      provides: "Integrated pet-aware action selection implementation"
      contains: "GetBestAction"
    - path: "TWL.Tests/PetTests/PetCombatAiTests.cs"
      provides: "Regression tests for pet action choice under party/element conditions"
      contains: "PetCombatAiTests"
  key_links:
    - from: "TWL.Server/Simulation/Managers/CombatManager.cs"
      to: "TWL.Server/Simulation/Managers/AutoBattleManager.cs"
      via: "pet turns invoke auto-battle action selection in encounter update loop"
      pattern: "GetBestAction"
    - from: "TWL.Server/Simulation/Managers/AutoBattleManager.cs"
      to: "TWL.Server/Simulation/Managers/PetBattlePolicy.cs"
      via: "decision logic consumes explicit pet policy thresholds"
      pattern: "PetBattlePolicy"
---

<objective>
Harden pet combat AI to satisfy PET-01 with deterministic, intelligent action selection.

Purpose: Ensure pet turns are strategically chosen based on battle context, not random behavior.
Output: Pet battle policy abstraction, AI integration updates, and pet-focused decision regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pet-system-completion/09-RESEARCH.md

@TWL.Server/Simulation/Managers/AutoBattleManager.cs
@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Server/Simulation/Networking/ServerPet.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce explicit pet battle policy abstraction</name>
  <files>
    TWL.Server/Simulation/Managers/PetBattlePolicy.cs
    TWL.Server/Simulation/Managers/AutoBattleManager.cs
  </files>
  <action>
    1. Add a dedicated `PetBattlePolicy` model for PET-01 priorities (ally survival, cleanse support, elemental target bias, SP thresholds).

    2. Refactor `AutoBattleManager` to use policy values for pet turns instead of hard-coded generic heuristics.

    3. Preserve deterministic ordering guarantees (stable tie-break behavior) to keep outcomes testable.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Pet AI behavior is policy-driven and explicitly aligned with PET-01 decision requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate pet-specific AI path in combat turn execution</name>
  <files>
    TWL.Server/Simulation/Managers/CombatManager.cs
    TWL.Server/Simulation/Managers/AutoBattleManager.cs
  </files>
  <action>
    1. Ensure `CombatManager.Update` routes pet turns through pet-focused AI policy path while preserving existing turn-engine rules.

    2. Keep enemy AI behavior intact and isolate pet-specific logic for maintainability.

    3. Verify no regression in disobedience handling and cooldown/turn progression.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Combat loop executes pet intelligence predictably with no random-only fallback behavior in standard conditions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pet AI decision regression tests for party and element contexts</name>
  <files>
    TWL.Tests/PetTests/PetCombatAiTests.cs
    TWL.Server/Simulation/Managers/AutoBattleManager.cs
  </files>
  <action>
    1. Add tests where low-HP ally context drives support/heal choices.

    2. Add tests where elemental advantage drives offensive target selection.

    3. Add deterministic tie-break tests to prevent non-repeatable AI drift.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetCombatAiTests"`
  </verify>
  <done>
    PET-01 intelligence criteria are regression-protected by pet-specific test coverage.
  </done>
</task>

</tasks>

<verification>
- [ ] Pet AI policy is explicit and configurable
- [ ] Combat loop uses pet-aware AI path
- [ ] Pet AI selects actions based on HP/party/element context
- [ ] Pet AI regression tests pass
</verification>

<success_criteria>
- PET-01 is implemented with deterministic server-authoritative logic
- Pet combat behavior quality is test-backed and non-random in equivalent scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/09-pet-system-completion/09-01-SUMMARY.md`
</output>

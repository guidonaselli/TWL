---
phase: 04-party-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - TWL.Server/Simulation/Managers/PartyChatService.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Shared/Domain/DTO/PartyChatDTOs.cs
  - TWL.Client/Presentation/Managers/GameClientManager.cs
  - TWL.Client/Presentation/UI/UiPartyWindow.cs
  - TWL.Client/Presentation/UI/UiGameplay.cs
  - TWL.Tests/Party/PartyChatChannelTests.cs
  - TWL.Tests/Party/PartyStateSyncTests.cs
autonomous: true

must_haves:
  truths:
    - "Party members see real-time member roster and HP/MP/status updates in gameplay UI"
    - "Party chat messages are visible only to members of the same party"
    - "Party membership changes are reflected on client UI without stale members"
  artifacts:
    - path: "TWL.Client/Presentation/UI/UiPartyWindow.cs"
      provides: "Party UI panel showing member slots and status bars"
      contains: "class UiPartyWindow"
    - path: "TWL.Server/Simulation/Managers/PartyChatService.cs"
      provides: "Server-side routing for party-private chat messages"
      contains: "class PartyChatService"
    - path: "TWL.Tests/Party/PartyStateSyncTests.cs"
      provides: "Regression checks for member add/remove/status sync"
      contains: "PartyStateSyncTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      via: "party snapshot/delta payloads published and consumed by client state"
      pattern: "Party.*Update"
    - from: "TWL.Server/Simulation/Managers/PartyChatService.cs"
      to: "TWL.Client/Presentation/UI/UiPartyWindow.cs"
      via: "party chat payloads rendered only for same-party membership"
      pattern: "PartyChat"
---

<objective>
Deliver real-time party state synchronization and private party chat with client-side party HUD support.

Purpose: This plan covers PTY-06 and PTY-07 by connecting server party events to user-visible party state and communication surfaces.
Output: Party chat service, party sync handlers, party UI panel, and deterministic sync/chat tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-party-system/04-RESEARCH.md
@.planning/phases/04-party-system/04-01-PLAN.md

@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Client/Presentation/Managers/GameClientManager.cs
@TWL.Client/Presentation/Networking/NetworkClient.cs
@TWL.Client/Presentation/UI/UiGameplay.cs
@TWL.Shared/Net/Messages/ServerMessageType.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement server-side party chat routing and sync payload contracts</name>
  <files>
    TWL.Server/Simulation/Managers/PartyChatService.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Shared/Domain/DTO/PartyChatDTOs.cs
  </files>
  <action>
    1. Add a dedicated `PartyChatService` that broadcasts party chat only to active sessions in the same party.

    2. Add chat + sync DTO contracts for:
       - party snapshot
       - member status delta (HP/MP/state)
       - chat message payload

    3. Wire `ClientSession` handlers for send-party-chat and party state push events, validating membership before delivery.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Party chat and state update payloads are server-enforced and delivered only to valid party members.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client party HUD/state integration for member status and party chat</name>
  <files>
    TWL.Client/Presentation/Managers/GameClientManager.cs
    TWL.Client/Presentation/UI/UiPartyWindow.cs
    TWL.Client/Presentation/UI/UiGameplay.cs
  </files>
  <action>
    1. Add client-side party state model in `GameClientManager` fed by server party snapshot/delta events.

    2. Create `UiPartyWindow` and integrate it with gameplay UI to show:
       - up to 4 members
       - leader marker
       - HP/MP/status per member

    3. Render party chat feed scoped to current party state; clear/update on leave/disconnect.
  </action>
  <verify>
    `dotnet build TWL.Client/TWL.Client.csproj` succeeds and no compile-time missing payload mappings remain.
  </verify>
  <done>
    Party UI reflects live server state and chat without leaking data across parties.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add synchronization and party-chat isolation tests</name>
  <files>
    TWL.Tests/Party/PartyChatChannelTests.cs
    TWL.Tests/Party/PartyStateSyncTests.cs
  </files>
  <action>
    1. Add tests proving party-chat isolation:
       - same party receives message
       - different party/non-party sessions do not receive message

    2. Add tests for state sync correctness:
       - member join/leave updates roster correctly
       - HP/MP/status updates map to correct member identity
       - stale members removed after leave/kick
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PartyChatChannelTests|FullyQualifiedName~PartyStateSyncTests"`
  </verify>
  <done>
    Party sync/chat behavior is regression-protected and scoped correctly by party membership.
  </done>
</task>

</tasks>

<verification>
- [ ] Party UI displays real-time member status for active party
- [ ] Party chat messages are visible only to same-party members
- [ ] Join/leave/kick events update client roster state deterministically
- [ ] Targeted sync/chat tests pass
</verification>

<success_criteria>
- PTY-06 and PTY-07 are implemented with server-authoritative sync and scoped communication
- Client party view is live, consistent, and membership-safe
- Chat/channel privacy is test-backed
</success_criteria>

<output>
After completion, create `.planning/phases/04-party-system/04-03-SUMMARY.md`
</output>

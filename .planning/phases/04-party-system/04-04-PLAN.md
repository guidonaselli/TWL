---
phase: 04-party-system
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - TWL.Shared/Domain/DTO/PartyFormationDTO.cs
  - TWL.Server/Simulation/Managers/PartyFormationService.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Managers/CombatManager.cs
  - TWL.Client/Presentation/UI/UiPartyWindow.cs
  - TWL.Client/Presentation/Scenes/SceneBattle.cs
  - TWL.Tests/Party/PartyFormationTests.cs
  - TWL.Tests/Party/PartyCombatFormationIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Party members can configure tactical formation in a 3x3 grid with front/mid/back semantics"
    - "Server validates formation updates and rejects invalid/duplicate slot assignments"
    - "Combat flow consumes formation information for row-sensitive behavior"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/PartyFormationService.cs"
      provides: "Server-authoritative formation grid validation and persistence"
      contains: "class PartyFormationService"
    - path: "TWL.Shared/Domain/DTO/PartyFormationDTO.cs"
      provides: "Network contracts for formation update requests and snapshots"
      contains: "FormationSlot"
    - path: "TWL.Tests/Party/PartyCombatFormationIntegrationTests.cs"
      provides: "Regression coverage for combat + formation wiring"
      contains: "PartyCombatFormationIntegrationTests"
  key_links:
    - from: "TWL.Client/Presentation/UI/UiPartyWindow.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "formation update requests sent to server"
      pattern: "Formation"
    - from: "TWL.Server/Simulation/Managers/PartyFormationService.cs"
      to: "TWL.Server/Simulation/Managers/CombatManager.cs"
      via: "formation row data influences combat targeting/effect resolution"
      pattern: "Front|Mid|Back|Row"
---

<objective>
Implement tactical party formation (3x3 grid) and integrate row-aware behavior into combat flow.

Purpose: This delivers PTY-08 by turning party composition into a tactical gameplay mechanic rather than a pure social grouping.
Output: Formation service + server/client formation sync + combat integration + deterministic formation tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-party-system/04-RESEARCH.md
@.planning/phases/04-party-system/04-01-PLAN.md
@.planning/phases/04-party-system/04-03-PLAN.md

@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Client/Presentation/Scenes/SceneBattle.cs
@TWL.Client/Presentation/UI/UiPartyWindow.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Shared/Domain/Skills/SkillEnums.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add formation domain contracts and server validation service</name>
  <files>
    TWL.Shared/Domain/DTO/PartyFormationDTO.cs
    TWL.Server/Simulation/Managers/PartyFormationService.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Define DTOs for formation slot assignment and party formation snapshot state.

    2. Add `PartyFormationService` to validate:
       - max 4 members mapped into 3x3 slot domain
       - unique member-per-slot and slot-per-member rules
       - leader authorization for team-wide formation edits (or policy-defined editor set)

    3. Add `ClientSession` request handling for formation updates and broadcast resulting canonical formation state.
  </action>
  <verify>
    `dotnet build TWL.Shared/TWL.Shared.csproj` and `dotnet build TWL.Server/TWL.Server.csproj` succeed.
  </verify>
  <done>
    Formation update contracts and server validation exist and reject malformed/unauthorized updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate formation rows into combat and battle presentation</name>
  <files>
    TWL.Server/Simulation/Managers/CombatManager.cs
    TWL.Client/Presentation/Scenes/SceneBattle.cs
  </files>
  <action>
    1. Integrate formation row metadata into combat target/effect flow where row semantics apply.

    2. Ensure row-sensitive skills (already represented in target enums) can consume party formation row data.

    3. Update battle scene presentation to reflect current formation positioning in a deterministic, non-overlapping layout.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Client/TWL.Client.csproj` succeed.
  </verify>
  <done>
    Combat and battle rendering both consume canonical formation state and apply row semantics consistently.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tactical formation regression and integration tests</name>
  <files>
    TWL.Tests/Party/PartyFormationTests.cs
    TWL.Tests/Party/PartyCombatFormationIntegrationTests.cs
    TWL.Client/Presentation/UI/UiPartyWindow.cs
  </files>
  <action>
    1. Add `PartyFormationTests` for validation logic:
       - valid slot assignment
       - duplicate slot/member rejection
       - unauthorized update rejection

    2. Add `PartyCombatFormationIntegrationTests` proving row-aware behavior is applied during combat resolution.

    3. Update `UiPartyWindow` interactions to emit valid formation updates and handle server rejection responses.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PartyFormationTests|FullyQualifiedName~PartyCombatFormationIntegrationTests"`
  </verify>
  <done>
    Formation mechanics are regression-protected and integrated from UI to combat behavior.
  </done>
</task>

</tasks>

<verification>
- [ ] Formation updates are server-validated and synchronized to party members
- [ ] Invalid slot/member assignments are rejected deterministically
- [ ] Combat row behavior consumes formation state where applicable
- [ ] Formation-focused tests pass
</verification>

<success_criteria>
- PTY-08 is implemented with authoritative server validation and combat integration
- Formation choices have visible tactical impact and stable client representation
- Formation pipeline is test-backed end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-party-system/04-04-SUMMARY.md`
</output>

---
phase: 04-party-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - TWL.Server/Simulation/Managers/PartyManager.cs
  - TWL.Server/Simulation/Managers/PartyRewardDistributor.cs
  - TWL.Server/Simulation/Managers/CombatManager.cs
  - TWL.Server/Persistence/Services/PlayerService.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Tests/Party/PartyRewardDistributionTests.cs
  - TWL.Tests/Party/PartyProximityRulesTests.cs
autonomous: true

must_haves:
  truths:
    - "Party members share XP only when on the same map and within configured proximity range"
    - "Party loot distribution follows configured party policy (round-robin or need/greed baseline flow)"
    - "Rewards are distributed once per encounter outcome without duplication"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/PartyRewardDistributor.cs"
      provides: "Centralized party XP/loot sharing logic with proximity checks"
      contains: "class PartyRewardDistributor"
    - path: "TWL.Server/Simulation/Managers/CombatManager.cs"
      provides: "Combat reward hook that routes encounter rewards through party distributor"
      contains: "OnCombatantDeath"
    - path: "TWL.Tests/Party/PartyRewardDistributionTests.cs"
      provides: "Deterministic tests for XP/loot sharing policy behavior"
      contains: "PartyRewardDistributionTests"
  key_links:
    - from: "TWL.Server/Simulation/Managers/CombatManager.cs"
      to: "TWL.Server/Simulation/Managers/PartyRewardDistributor.cs"
      via: "encounter result triggers party reward distribution"
      pattern: "Reward|Distribute"
    - from: "TWL.Server/Simulation/Managers/PartyRewardDistributor.cs"
      to: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      via: "member map/position/party state used for proximity eligibility"
      pattern: "MapId|X|Y|PartyId"
---

<objective>
Implement party XP and loot sharing with strict same-map/proximity enforcement and deterministic anti-duplication behavior.

Purpose: This delivers PTY-04 and PTY-05 so party play affects progression and rewards correctly without exploit windows.
Output: Shared reward distributor integrated with combat outcomes and fully covered by focused reward/proximity tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-party-system/04-RESEARCH.md
@.planning/phases/04-party-system/04-01-PLAN.md

@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Server/Simulation/Managers/SpawnManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Persistence/Services/PlayerService.cs
@TWL.Server/Simulation/Managers/PartyManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add party reward distributor with proximity and policy rules</name>
  <files>
    TWL.Server/Simulation/Managers/PartyRewardDistributor.cs
    TWL.Server/Simulation/Managers/PartyManager.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add `PartyRewardDistributor` service that computes eligible members using:
       - same `MapId`
       - max distance threshold between members and encounter location
       - party membership snapshot from `PartyManager`

    2. Support at least:
       - XP split policy for eligible online members
       - loot policy strategy hooks (`round-robin` now, extensible for need/greed)

    3. Keep distribution idempotent per encounter/reward event to prevent duplicate grants.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` succeeds.
  </verify>
  <done>
    Party reward logic exists as a reusable service with explicit eligibility and distribution policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate party reward flow into combat outcome path</name>
  <files>
    TWL.Server/Simulation/Managers/CombatManager.cs
    TWL.Server/Persistence/Services/PlayerService.cs
  </files>
  <action>
    1. Wire party reward distributor into combat death/reward path where encounter outcome is resolved.

    2. Ensure reward fan-out reaches active member sessions through existing session access patterns without bypassing server authority.

    3. Preserve non-party reward behavior for solo players.
  </action>
  <verify>
    Run targeted reward tests plus existing combat smoke tests:
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CombatManager|FullyQualifiedName~PartyRewardDistributionTests|FullyQualifiedName~PartyProximityRulesTests"`
  </verify>
  <done>
    Encounter rewards are routed through party-aware distribution for grouped players and remain correct for solo flows.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add deterministic tests for XP/loot sharing and proximity gates</name>
  <files>
    TWL.Tests/Party/PartyRewardDistributionTests.cs
    TWL.Tests/Party/PartyProximityRulesTests.cs
  </files>
  <action>
    1. Add tests covering:
       - same-map + in-range members receive shared XP
       - out-of-range members do not receive XP
       - round-robin loot assignment progression
       - idempotent replay of same reward event does not duplicate grants

    2. Keep tests deterministic (fixed coordinates and seeded/random-independent expectations).
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PartyRewardDistributionTests|FullyQualifiedName~PartyProximityRulesTests"`
  </verify>
  <done>
    Reward sharing policies are regression-protected and proximity enforcement is provably correct.
  </done>
</task>

</tasks>

<verification>
- [ ] Party XP share requires same map + proximity
- [ ] Loot distribution respects configured policy flow
- [ ] Distribution is idempotent per encounter reward event
- [ ] Targeted party reward tests pass
</verification>

<success_criteria>
- PTY-04 and PTY-05 are implemented with server-authoritative enforcement
- Reward sharing cannot be exploited by out-of-range/off-map party members
- Reward behavior is test-covered and stable across regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-party-system/04-02-SUMMARY.md`
</output>

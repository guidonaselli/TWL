---
phase: 04-party-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/IPartyService.cs
  - TWL.Server/Simulation/Managers/PartyManager.cs
  - TWL.Shared/Domain/DTO/PartyDTOs.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Program.cs
  - TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
  - TWL.Tests/Party/PartyLifecycleTests.cs
  - TWL.Tests/Quests/PvPAndGatingTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can create a party, invite members, and receive accept/decline outcomes"
    - "Players can leave parties and leaders can kick members"
    - "Kick attempts are rejected when target or leader is in combat/boss encounter"
    - "Party-required quest gating is enforced consistently in quest start flow"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/PartyManager.cs"
      provides: "Server-authoritative party lifecycle state and membership operations"
      contains: "class PartyManager"
    - path: "TWL.Shared/Domain/DTO/PartyDTOs.cs"
      provides: "Canonical network payload contracts for party operations"
      contains: "PartyInvite"
    - path: "TWL.Server/Simulation/Networking/ClientSession.cs"
      provides: "Opcode handlers for party invite/accept/decline/leave/kick"
      contains: "HandleParty"
  key_links:
    - from: "TWL.Shared/Net/Network/Opcode.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "party opcodes dispatched to party handlers"
      pattern: "PartyInvite|PartyAccept|PartyDecline|PartyLeave|PartyKick"
    - from: "TWL.Server/Simulation/Managers/PartyManager.cs"
      to: "TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs"
      via: "party membership reflected in character party state for gating"
      pattern: "PartyId"
---

<objective>
Implement the server-authoritative party lifecycle foundation (create/invite/accept/decline/leave/kick) and align quest gating with party membership rules.

Purpose: This establishes PTY-01, PTY-02, PTY-03, and PTY-09 as the base contract for all later party reward/chat/formation work.
Output: Party service + protocol DTOs + opcode handlers + deterministic lifecycle tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-party-system/04-RESEARCH.md

@TWL.Shared/Net/Network/Opcode.cs
@TWL.Shared/Net/Messages/ClientMessageType.cs
@TWL.Shared/Net/Messages/ServerMessageType.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
@TWL.Tests/Quests/PvPAndGatingTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create party domain service and protocol DTO contracts</name>
  <files>
    TWL.Server/Simulation/Managers/IPartyService.cs
    TWL.Server/Simulation/Managers/PartyManager.cs
    TWL.Shared/Domain/DTO/PartyDTOs.cs
    TWL.Shared/Net/Network/Opcode.cs
  </files>
  <action>
    1. Add `IPartyService` + `PartyManager` with server-authoritative structures for:
       - party identity and leader
       - up to 4-member roster
       - pending invite tracking with expiration
       - membership mutation operations (invite/accept/decline/leave/kick)

    2. Add strongly typed party DTOs for request/response/broadcast payloads in shared domain.

    3. Extend `Opcode` with party opcodes needed by server/client runtime packet routing.

    4. Keep message naming consistent with existing enums to avoid protocol drift.
  </action>
  <verify>
    `dotnet build TWL.Shared/TWL.Shared.csproj` and `dotnet build TWL.Server/TWL.Server.csproj` succeed.
  </verify>
  <done>
    Party domain and wire contracts exist, compile cleanly, and can represent full invite-to-membership lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire party handlers in server session and enforce combat-safe kick restrictions</name>
  <files>
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Simulation/Program.cs
    TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
  </files>
  <action>
    1. Register `IPartyService`/`PartyManager` in DI and inject into `ClientSession`.

    2. Add `ClientSession` handlers for party opcodes:
       - invite
       - accept
       - decline
       - leave
       - kick
       Emit server messages for inviter/invitee/party members on each state transition.

    3. Enforce PTY-09 policy:
       - reject kick if leader or target is currently in combat/boss context
       - return explicit reason in response payload

    4. Fix party/guild gating parity:
       ensure `StartQuest` path enforces `PartyRules` and `GuildRules` consistently (same behavior as `CanStartQuest`).
  </action>
  <verify>
    Run `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PvPAndGatingTests"` and verify the party-required gating test passes.
  </verify>
  <done>
    Party operations are executable through network handlers, kick safety policy is enforced, and quest party gating is no longer bypassed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add lifecycle regression tests for invite/join/leave/kick behavior</name>
  <files>
    TWL.Tests/Party/PartyLifecycleTests.cs
    TWL.Tests/Quests/PvPAndGatingTests.cs
  </files>
  <action>
    1. Add new `PartyLifecycleTests` covering:
       - create + invite + accept
       - invite + decline
       - leave flow
       - leader kick flow
       - max party size enforcement (4 members)

    2. Add/extend tests that assert kick rejection while combat/boss lock is active.

    3. Keep tests deterministic and independent from unrelated systems.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PartyLifecycleTests|FullyQualifiedName~PvPAndGatingTests"`
  </verify>
  <done>
    Core party lifecycle behavior is codified and fails fast on regression.
  </done>
</task>

</tasks>

<verification>
- [ ] Party lifecycle handlers compile and execute through `ClientSession`
- [ ] Quest party/guild gating tests pass (no bypass in `StartQuest`)
- [ ] Kick is blocked during combat/boss conditions
- [ ] Party size cap (4) is enforced by server
</verification>

<success_criteria>
- PTY-01, PTY-02, PTY-03, PTY-09 are implemented at server-contract level
- Party membership is authoritative and synchronized by network events
- Party-required quest gating is behaviorally correct and test-backed
</success_criteria>

<output>
After completion, create `.planning/phases/04-party-system/04-01-SUMMARY.md`
</output>

---
phase: 03-content-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Content/Data/quests.json
  - Content/Data/interactions.json
  - TWL.Tests/HiddenRuinsQuestTests.cs
  - TWL.Tests/QuestRuinsExpansionTests.cs
  - TWL.Tests/Quests/QuestValidationTests.cs
autonomous: true

must_haves:
  truths:
    - "Hidden Ruins and Ruins Expansion quest chains progress from start to reward claim without blockers"
    - "Quest prerequisites and objective target names for quests 1301-1307 remain internally consistent"
    - "Arc regressions fail fast through deterministic automated tests"
  artifacts:
    - path: "Content/Data/quests.json"
      provides: "Canonical quest definitions for hidden-ruins and ruins-expansion arcs"
      contains: "\"QuestId\": 1301"
    - path: "Content/Data/interactions.json"
      provides: "Interaction-to-item/progression mappings required by ruins arc objectives"
      contains: "StrangeStoneDebris"
    - path: "TWL.Tests/QuestRuinsExpansionTests.cs"
      provides: "End-to-end progression assertions for 1305-1307 and sidequest coverage"
      contains: "SecretsOfTheRuins_Chain_Progression"
  key_links:
    - from: "Content/Data/quests.json"
      to: "Content/Data/interactions.json"
      via: "objective target names must match interaction identifiers"
      pattern: "StrangeStoneDebris|AncientTablet|RuinsEntrance|RuinsConsole|PowerCrystalSource|BatNest"
    - from: "TWL.Tests/HiddenRuinsQuestTests.cs"
      to: "Content/Data/quests.json"
      via: "quest progression tests assert start/progress/claim flow"
      pattern: "StartQuest\\(1301\\)|ClaimReward\\(1304\\)"
---

<objective>
Stabilize Hidden Ruins and Ruins Expansion content so quest chains are internally consistent and regression-safe.

Purpose: This plan covers the highest-risk content branch in QUAL-01 by making quest data and interaction behavior explicit, test-backed, and resilient to drift.
Output: Updated quest/interaction content for the 1301-1307 branch plus stronger targeted tests and validator checks.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-quality/03-RESEARCH.md

@docs/quests/ROADMAP.md
@docs/quests/design/2024-05-24-hidden-ruins.md
@docs/quests/design/2024-05-22-signs-of-life.md
@Content/Data/quests.json
@Content/Data/interactions.json
@TWL.Tests/HiddenRuinsQuestTests.cs
@TWL.Tests/QuestRuinsExpansionTests.cs
@TWL.Tests/Quests/QuestValidationTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reconcile Hidden Ruins and Ruins Expansion quest definitions</name>
  <files>
    Content/Data/quests.json
  </files>
  <action>
    1. Audit quests `1301-1307` and relevant sidequests used by the ruins tests (including `2303`) for:
       - prerequisite chain continuity
       - objective type + target name alignment
       - reward payload validity and idempotency-friendly repeatability settings

    2. Ensure quest objective targets match test expectations and interaction identifiers used by the current gameplay flow.

    3. Preserve existing validated behavior outside this arc; do not rework unrelated quest ranges.
  </action>
  <verify>
    Run `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~HiddenRuinsQuestTests|FullyQualifiedName~QuestRuinsExpansionTests"` and confirm pass.
  </verify>
  <done>
    Ruins branch quest definitions are coherent, with start/progress/claim steps aligned to the tested progression path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Align interaction mappings that gate ruins progression</name>
  <files>
    Content/Data/interactions.json
  </files>
  <action>
    1. Validate and correct interaction entries used by this arc:
       - `StrangeStoneDebris`
       - `AncientTablet`
       - `RuinsEntrance`
       - `RuinsConsole`
       - `PowerCrystalSource`
       - `BatNest`
       - `HologramProjector`

    2. Confirm interaction outputs (items/progression trigger side-effects) are consistent with quest objectives and test assertions.

    3. Keep identifiers stable; avoid renaming interaction keys unless tests and quest data are updated in the same change.
  </action>
  <verify>
    Re-run `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~HiddenRuinsQuestTests|FullyQualifiedName~QuestRuinsExpansionTests"`.
  </verify>
  <done>
    Interaction data fully supports the ruins quest chain without missing or mismatched targets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Harden ruins regression coverage for drift detection</name>
  <files>
    TWL.Tests/HiddenRuinsQuestTests.cs
    TWL.Tests/QuestRuinsExpansionTests.cs
    TWL.Tests/Quests/QuestValidationTests.cs
  </files>
  <action>
    1. Add focused assertions for failure-prone edges:
       - prerequisite gating (cannot start without required prior quest state)
       - target-name mismatches that should fail progression
       - reward-claim sequence consistency for critical chain steps

    2. Keep test setup deterministic and isolated from unrelated content changes.

    3. Add or extend production quest validation checks where useful to fail fast on arc-level structural issues.
  </action>
  <verify>
    Run `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~HiddenRuinsQuestTests|FullyQualifiedName~QuestRuinsExpansionTests|FullyQualifiedName~QuestValidationTests"`.
  </verify>
  <done>
    Automated tests detect both positive progression and key negative-path regressions for the ruins branch.
  </done>
</task>

</tasks>

<verification>
- [ ] `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~HiddenRuinsQuestTests|FullyQualifiedName~QuestRuinsExpansionTests"` passes
- [ ] Quest IDs 1301-1307 objective targets map to valid interaction identifiers
- [ ] Regression assertions cover prerequisite and target mismatch failure modes
- [ ] Production quest validation tests remain green
</verification>

<success_criteria>
- QUAL-01 ruins arc scope is stabilized with executable, deterministic coverage
- Quest and interaction data for this branch are aligned and drift-resistant
- Critical chain progression cannot silently regress without failing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-quality/03-01-SUMMARY.md`
</output>

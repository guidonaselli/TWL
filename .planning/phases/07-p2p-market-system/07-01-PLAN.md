---
phase: 07-p2p-market-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/IMarketService.cs
  - TWL.Server/Simulation/Managers/MarketManager.cs
  - TWL.Server/Persistence/Database/DbService.cs
  - TWL.Shared/Domain/DTO/MarketDTOs.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Program.cs
  - TWL.Tests/Market/MarketContractTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can interact with a server-authoritative market API rather than local in-memory listings"
    - "Market listings have explicit persisted state and lifecycle identity"
    - "Market operations are reachable through dedicated network contracts"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/MarketManager.cs"
      provides: "Canonical market domain operations and listing state ownership"
      contains: "class MarketManager"
    - path: "TWL.Shared/Domain/DTO/MarketDTOs.cs"
      provides: "Request/response contracts for listing, search, cancel, and purchase operations"
      contains: "CreateMarketListingRequest"
    - path: "TWL.Server/Persistence/Database/DbService.cs"
      provides: "Market persistence schema bootstrap for listings/history tables"
      contains: "market_listings"
  key_links:
    - from: "TWL.Shared/Net/Network/Opcode.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "market opcodes dispatch into market handlers"
      pattern: "MarketCreateListing|MarketSearch|MarketBuy|MarketCancel"
    - from: "TWL.Server/Simulation/Program.cs"
      to: "TWL.Server/Simulation/Managers/MarketManager.cs"
      via: "DI registration wires market service into runtime"
      pattern: "AddSingleton<IMarketService>|AddSingleton<MarketManager>"
---

<objective>
Create Phase 7 market foundation: domain service, persistence schema, and network contracts.

Purpose: This establishes the server-authoritative base needed for all listing/search/purchase/trade features.
Output: Market service interface + manager, DTO/opcode surface, persistence schema updates, and contract tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2p-market-system/07-RESEARCH.md

@TWL.Server/Simulation/Managers/EconomyManager.cs
@TWL.Server/Simulation/Managers/TradeManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Shared/Net/Network/Opcode.cs
@TWL.Server/Persistence/Database/DbService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add market domain service and DTO contracts</name>
  <files>
    TWL.Server/Simulation/Managers/IMarketService.cs
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Shared/Domain/DTO/MarketDTOs.cs
  </files>
  <action>
    1. Add `IMarketService` and `MarketManager` with market listing aggregate operations (create/search/buy/cancel/expire baseline contracts).

    2. Define strongly-typed DTOs for market requests, listing summaries, and operation results.

    3. Keep contract naming aligned with existing DTO style (`*DTO`, `*Request`, `*Response`) to reduce friction in session handlers.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Market operations are represented by compile-safe server contracts and DTOs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add market persistence schema and wire service into runtime</name>
  <files>
    TWL.Server/Persistence/Database/DbService.cs
    TWL.Server/Simulation/Program.cs
  </files>
  <action>
    1. Extend DB initialization with market listing and market transaction-history tables required by phase requirements.

    2. Register `IMarketService`/`MarketManager` in DI.

    3. Ensure schema and DI changes remain backward-compatible with existing startup flow.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Market state has persistence backing and service is available at runtime.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add market opcode routing and contract tests</name>
  <files>
    TWL.Shared/Net/Network/Opcode.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Tests/Market/MarketContractTests.cs
  </files>
  <action>
    1. Add market opcodes and skeleton session handlers for create/search/buy/cancel flows.

    2. Route handlers through `IMarketService` and return explicit structured responses.

    3. Add contract tests validating opcode dispatch and payload deserialization expectations.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~MarketContractTests"`
  </verify>
  <done>
    Market network contracts are reachable and test-backed.
  </done>
</task>

</tasks>

<verification>
- [ ] Market service and DTO contracts exist
- [ ] Market persistence schema is initialized
- [ ] Market opcodes are present and routed in `ClientSession`
- [ ] Market contract tests pass
</verification>

<success_criteria>
- Foundation for MKT-01..MKT-08 is in place with server authority
- Market state and operations are network-addressable and persisted
- Phase 7 can proceed with lifecycle/query/settlement features on stable contracts
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2p-market-system/07-01-SUMMARY.md`
</output>

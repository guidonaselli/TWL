---
phase: 07-p2p-market-system
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - TWL.Server/Simulation/Managers/MarketManager.cs
  - TWL.Server/Simulation/Managers/EconomyManager.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Shared/Domain/DTO/MarketDTOs.cs
  - TWL.Server/Persistence/Database/DbService.cs
  - TWL.Tests/Market/MarketPurchaseSettlementTests.cs
  - TWL.Tests/Market/MarketIdempotencyTests.cs
  - TWL.Tests/Market/MarketTaxCalculationTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can purchase listings with atomic gold/item transfer between buyer and seller"
    - "Market purchase applies configurable tax and transfers net proceeds correctly"
    - "Duplicate purchase attempts are idempotent and cannot double-spend or duplicate items"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/MarketManager.cs"
      provides: "Atomic listing purchase settlement orchestration"
      contains: "BuyListing"
    - path: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      provides: "Tax configuration and ledger-aligned settlement logging hooks"
      contains: "MarketTax"
    - path: "TWL.Tests/Market/MarketIdempotencyTests.cs"
      provides: "Replay and duplicate-operation regression coverage"
      contains: "MarketIdempotencyTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/MarketManager.cs"
      via: "buy-listing handler delegates purchase settlement with operation id"
      pattern: "HandleMarketBuy"
    - from: "TWL.Server/Simulation/Managers/MarketManager.cs"
      to: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      via: "purchase settlement uses shared economy math/logging and tax policy"
      pattern: "TaxRate|LogLedger"
    - from: "TWL.Server/Simulation/Managers/MarketManager.cs"
      to: "TWL.Server/Persistence/Database/DbService.cs"
      via: "purchase commits listing status and sale history atomically"
      pattern: "market_listings|market_transactions"
---

<objective>
Implement listing purchase settlement with atomic transfer, tax handling, and idempotency.

Purpose: This delivers MKT-03 and MKT-06 while satisfying MKT-08's anti-duplication expectation for valuable transfers.
Output: Atomic purchase flow + configurable tax policy + settlement/idempotency/tax regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2p-market-system/07-RESEARCH.md
@.planning/phases/07-p2p-market-system/07-02-PLAN.md
@.planning/phases/07-p2p-market-system/07-03-PLAN.md

@TWL.Server/Simulation/Managers/MarketManager.cs
@TWL.Server/Simulation/Managers/EconomyManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement atomic market purchase settlement</name>
  <files>
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Shared/Domain/DTO/MarketDTOs.cs
  </files>
  <action>
    1. Implement buy-listing flow that atomically debits buyer gold, transfers item to buyer, and credits seller proceeds.

    2. Enforce listing availability and quantity constraints under concurrent buy attempts.

    3. Require operation ids for idempotent purchase retries and return stable replay responses.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Listing purchase executes as atomic, replay-safe settlement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add configurable tax policy and settlement persistence updates</name>
  <files>
    TWL.Server/Simulation/Managers/EconomyManager.cs
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Server/Persistence/Database/DbService.cs
  </files>
  <action>
    1. Add configurable market tax rate (target 5-10%) applied to gross sale amount.

    2. Ensure seller receives net proceeds after tax and transaction history records gross, tax, and net amounts.

    3. Persist completed settlement records for price history and operational auditability.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Market tax policy is applied consistently and persisted in settlement history.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add purchase, tax, and idempotency regression tests</name>
  <files>
    TWL.Tests/Market/MarketPurchaseSettlementTests.cs
    TWL.Tests/Market/MarketIdempotencyTests.cs
    TWL.Tests/Market/MarketTaxCalculationTests.cs
  </files>
  <action>
    1. Add purchase settlement tests for success, insufficient funds, and sold/expired listing edge paths.

    2. Add idempotency tests proving duplicate operation ids do not repeat debits/credits/item movement.

    3. Add tax tests validating gross/tax/net calculations and rounding behavior.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~MarketPurchaseSettlementTests|FullyQualifiedName~MarketIdempotencyTests|FullyQualifiedName~MarketTaxCalculationTests"`
  </verify>
  <done>
    Purchase settlement, tax math, and replay safety are regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Buy-listing flow is atomic and concurrency-safe
- [ ] Market tax is configurable and applied to seller payouts
- [ ] Purchase operations are idempotent by operation id
- [ ] Settlement/idempotency/tax tests pass
</verification>

<success_criteria>
- MKT-03 and MKT-06 implemented with transaction-safe settlement
- Market purchase path resists duplicate execution and race exploitation
- Settlement data supports downstream analytics and audits
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2p-market-system/07-04-SUMMARY.md`
</output>

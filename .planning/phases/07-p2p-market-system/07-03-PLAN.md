---
phase: 07-p2p-market-system
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - TWL.Server/Simulation/Managers/MarketQueryService.cs
  - TWL.Server/Simulation/Managers/MarketManager.cs
  - TWL.Shared/Domain/DTO/MarketDTOs.cs
  - TWL.Shared/Domain/Requests/MarketplaceUpdate.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
  - TWL.Tests/Market/MarketSearchTests.cs
  - TWL.Tests/Market/MarketPriceHistoryTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can search and filter listings by name, type, price range, and rarity"
    - "Market query responses are server-driven and stable for client rendering"
    - "Players can view min/avg/max price history for recent item transactions"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/MarketQueryService.cs"
      provides: "Search/filter read-model and query execution logic"
      contains: "SearchListings"
    - path: "TWL.Server/Simulation/Managers/MarketManager.cs"
      provides: "Completed-sale history capture used for price analytics projection"
      contains: "RecordSaleHistory"
    - path: "TWL.Tests/Market/MarketPriceHistoryTests.cs"
      provides: "Regression coverage for min/avg/max history calculations"
      contains: "MarketPriceHistoryTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/MarketQueryService.cs"
      via: "market search opcodes dispatch to query service"
      pattern: "HandleMarketSearch"
    - from: "TWL.Shared/Domain/Requests/MarketplaceUpdate.cs"
      to: "TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs"
      via: "listing snapshots/history payloads hydrate client market view state"
      pattern: "Listings|PriceHistory"
---

<objective>
Implement market discovery features: listing filters and item price-history analytics.

Purpose: This delivers MKT-02 and MKT-05 and prepares stable query/read flows for execution UI.
Output: Query service + search/history DTO expansion + client ingestion + search/history regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2p-market-system/07-RESEARCH.md
@.planning/phases/07-p2p-market-system/07-01-PLAN.md

@TWL.Server/Simulation/Managers/MarketManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Shared/Domain/Requests/MarketplaceUpdate.cs
@TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement listing search/filter query path</name>
  <files>
    TWL.Server/Simulation/Managers/MarketQueryService.cs
    TWL.Shared/Domain/DTO/MarketDTOs.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Add query contracts supporting filters for item name, item type, rarity, and price range.

    2. Implement `MarketQueryService` with deterministic filter application and paging-ready response structure.

    3. Add search handler in `ClientSession` returning server-side query results.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Market listing search/filter is server-authoritative and network-accessible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement completed-sale history projection (min/avg/max)</name>
  <files>
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Shared/Domain/DTO/MarketDTOs.cs
    TWL.Shared/Domain/Requests/MarketplaceUpdate.cs
  </files>
  <action>
    1. Capture sale records for completed purchases with item id, sold price, quantity, and timestamp.

    2. Add price-history projection returning min/avg/max over configurable recent history windows.

    3. Extend market update payloads so client can consume history data together with listing snapshots.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Price-history analytics are available from completed market transactions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire client market state ingestion and add query/history tests</name>
  <files>
    TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
    TWL.Tests/Market/MarketSearchTests.cs
    TWL.Tests/Market/MarketPriceHistoryTests.cs
  </files>
  <action>
    1. Update client market manager to consume server listing snapshots and price-history payloads.

    2. Add search tests for filter combinations and deterministic result sets.

    3. Add price-history tests validating min/avg/max math and empty-history behavior.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~MarketSearchTests|FullyQualifiedName~MarketPriceHistoryTests"`
  </verify>
  <done>
    Search and price-history behavior is integrated and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Listing search supports name/type/rarity/price-range filters
- [ ] Price-history exposes min/avg/max based on completed sales
- [ ] Client marketplace manager consumes server-driven listing/history payloads
- [ ] Search and history tests pass
</verification>

<success_criteria>
- MKT-02 and MKT-05 implemented with deterministic query behavior
- Market read model is usable by client and future UI evolution
- Listing analytics are derived from authoritative sale history
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2p-market-system/07-03-SUMMARY.md`
</output>

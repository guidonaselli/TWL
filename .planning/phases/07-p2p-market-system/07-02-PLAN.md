---
phase: 07-p2p-market-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - TWL.Server/Simulation/Managers/MarketManager.cs
  - TWL.Server/Simulation/Managers/MarketListingScheduler.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Persistence/Services/PlayerService.cs
  - TWL.Shared/Domain/DTO/MarketDTOs.cs
  - TWL.Tests/Market/MarketListingLifecycleTests.cs
  - TWL.Tests/Market/MarketExpirationTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can create listings with price, quantity, and expiration window"
    - "Players can cancel their own active listings and receive item return"
    - "Expired listings return unsold items automatically to seller inventory"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/MarketManager.cs"
      provides: "Listing creation/cancel/expiration state machine with seller ownership checks"
      contains: "CreateListing|CancelListing|ExpireListing"
    - path: "TWL.Server/Simulation/Managers/MarketListingScheduler.cs"
      provides: "Periodic expiration worker for listing timeout processing"
      contains: "ProcessExpiredListings"
    - path: "TWL.Tests/Market/MarketListingLifecycleTests.cs"
      provides: "Listing create/cancel authorization and inventory return regression tests"
      contains: "MarketListingLifecycleTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/MarketManager.cs"
      via: "listing create/cancel handlers call server-authoritative market manager"
      pattern: "HandleMarketCreate|HandleMarketCancel"
    - from: "TWL.Server/Simulation/Managers/MarketListingScheduler.cs"
      to: "TWL.Server/Persistence/Services/PlayerService.cs"
      via: "expiration return flow resolves seller sessions/data safely"
      pattern: "GetSession|LoadData"
---

<objective>
Implement listing lifecycle operations including create, cancel, and automatic expiration return.

Purpose: This delivers MKT-01, MKT-04, and MKT-07 with abuse-resistant lifecycle handling.
Output: Listing state machine + expiration scheduler + lifecycle regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2p-market-system/07-RESEARCH.md
@.planning/phases/07-p2p-market-system/07-01-PLAN.md

@TWL.Server/Simulation/Managers/MarketManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Persistence/Services/PlayerService.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement listing create/cancel lifecycle with seller ownership checks</name>
  <files>
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Shared/Domain/DTO/MarketDTOs.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Implement create-listing flow enforcing valid price/quantity/expiration bounds and inventory availability.

    2. Implement cancel-listing flow restricted to seller ownership with safe item return behavior.

    3. Ensure listing status transitions are explicit (`Active`, `Cancelled`, `Expired`, `Sold`) and terminal states are not reprocessed.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Listing create and cancel operations are server-authoritative and lifecycle-safe.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add expiration scheduler and item-return pipeline</name>
  <files>
    TWL.Server/Simulation/Managers/MarketListingScheduler.cs
    TWL.Server/Simulation/Managers/MarketManager.cs
    TWL.Server/Persistence/Services/PlayerService.cs
  </files>
  <action>
    1. Add `MarketListingScheduler` to process expired active listings on a periodic interval.

    2. Return unsold items to seller inventory with safe fallback behavior for offline sellers.

    3. Ensure expiration path is idempotent and cannot return items multiple times.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Expired listings are processed and returned exactly once.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add lifecycle and expiration regression tests</name>
  <files>
    TWL.Tests/Market/MarketListingLifecycleTests.cs
    TWL.Tests/Market/MarketExpirationTests.cs
  </files>
  <action>
    1. Add tests for listing creation success/failure and seller-only cancel authorization.

    2. Add tests validating expiration-triggered item return for active listings.

    3. Add duplicate-processing tests proving cancel/expiration do not double-return inventory.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~MarketListingLifecycleTests|FullyQualifiedName~MarketExpirationTests"`
  </verify>
  <done>
    Listing lifecycle behavior is deterministic and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Listing creation enforces valid price/quantity/expiration input and inventory availability
- [ ] Listing cancel is seller-authorized and returns listed items
- [ ] Expired listings auto-return unsold items exactly once
- [ ] Listing lifecycle tests pass
</verification>

<success_criteria>
- MKT-01, MKT-04, and MKT-07 implemented with server-authoritative lifecycle safety
- Listing state transitions are explicit and terminal-state safe
- Expiration behavior is operationally reliable
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2p-market-system/07-02-SUMMARY.md`
</output>

---
phase: 07-p2p-market-system
plan: 05
type: execute
wave: 4
depends_on: ["07-04"]
files_modified:
  - TWL.Server/Simulation/Managers/TradeSessionManager.cs
  - TWL.Server/Simulation/Managers/TradeManager.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Shared/Domain/DTO/TradeDTOs.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Client/Presentation/Managers/GameClientManager.cs
  - TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
  - TWL.Client/Presentation/UI/UiTradeWindow.cs
  - TWL.Tests/Market/DirectTradeWindowTests.cs
  - TWL.Tests/Market/MarketTradeIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can run direct player-to-player trade with both-party confirmation before transfer"
    - "Direct trade honors existing bind-policy transfer restrictions and rejects unsafe transfers"
    - "Client market/trade UI reflects server-authoritative trade state changes"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/TradeSessionManager.cs"
      provides: "Trade session lifecycle state for request/accept/cancel/confirm handshake"
      contains: "class TradeSessionManager"
    - path: "TWL.Shared/Domain/DTO/TradeDTOs.cs"
      provides: "Network contracts for direct trade window interactions"
      contains: "TradeRequestDto"
    - path: "TWL.Client/Presentation/UI/UiTradeWindow.cs"
      provides: "Client trade window rendering and interaction hooks for two-party confirmation flow"
      contains: "class UiTradeWindow"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/TradeSessionManager.cs"
      via: "direct trade opcodes drive trade session handshake and confirmation"
      pattern: "TradeRequest|TradeAccept|TradeConfirm|TradeCancel"
    - from: "TWL.Server/Simulation/Managers/TradeSessionManager.cs"
      to: "TWL.Server/Simulation/Managers/TradeManager.cs"
      via: "confirmed trades execute through existing bind-policy-safe transfer logic"
      pattern: "TransferItem"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      via: "trade session updates propagate into client manager/UI state"
      pattern: "TradeUpdate"
---

<objective>
Implement direct player-to-player trade window and finalize client market/trade integration.

Purpose: This delivers MKT-08 and completes the market phase with a server-authoritative live trading path.
Output: Trade session manager + trade DTO/opcode routing + client trade window integration + direct-trade regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2p-market-system/07-RESEARCH.md
@.planning/phases/07-p2p-market-system/07-04-PLAN.md

@TWL.Server/Simulation/Managers/TradeManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Client/Presentation/Managers/GameClientManager.cs
@TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
@TWL.Client/Presentation/UI/UiMarketplace.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add direct trade session handshake and network contracts</name>
  <files>
    TWL.Server/Simulation/Managers/TradeSessionManager.cs
    TWL.Shared/Domain/DTO/TradeDTOs.cs
    TWL.Shared/Net/Network/Opcode.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Implement trade session lifecycle (request, accept/decline, staged offers, confirm, cancel).

    2. Add trade DTO/opcode contracts for both-party confirmation workflow.

    3. Ensure final item movement executes only on dual confirmation and routes through existing validated transfer behavior.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Direct trade handshake is server-authoritative and fully network-addressable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate client trade window and server-driven state updates</name>
  <files>
    TWL.Client/Presentation/Managers/GameClientManager.cs
    TWL.Client/Presentation/Managers/ClientMarketplaceManager.cs
    TWL.Client/Presentation/UI/UiTradeWindow.cs
  </files>
  <action>
    1. Add client trade-state handling in `GameClientManager` and market manager integration points.

    2. Implement `UiTradeWindow` for request/offer/confirm/cancel interactions.

    3. Ensure UI state is driven by server events and does not perform local-authoritative item/gold mutation.
  </action>
  <verify>
    `dotnet build TWL.Client/TWL.Client.csproj`
  </verify>
  <done>
    Direct trade UI is functional and synchronized with server state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add direct-trade and market-trade integration tests</name>
  <files>
    TWL.Tests/Market/DirectTradeWindowTests.cs
    TWL.Tests/Market/MarketTradeIntegrationTests.cs
    TWL.Server/Simulation/Managers/TradeManager.cs
  </files>
  <action>
    1. Add direct-trade tests for request/accept/confirm/cancel flows and both-party-confirm requirement.

    2. Add integration tests proving bind-policy restrictions remain enforced in direct trade window flows.

    3. Add compatibility checks ensuring market listings and direct trade do not conflict on reserved inventory items.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~DirectTradeWindowTests|FullyQualifiedName~MarketTradeIntegrationTests"`
  </verify>
  <done>
    Direct trade workflow is regression-protected and safely integrated with market inventory behavior.
  </done>
</task>

</tasks>

<verification>
- [ ] Direct trade requires both-party confirmation before transfer
- [ ] Trade flow reuses bind-policy-safe transfer enforcement
- [ ] Client trade window reflects server-authoritative state updates
- [ ] Direct-trade integration tests pass
</verification>

<success_criteria>
- MKT-08 implemented as server-authoritative direct trade window
- Trade security invariants remain intact under new workflow
- Phase 7 market + trade flows are execution-ready end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2p-market-system/07-05-SUMMARY.md`
</output>

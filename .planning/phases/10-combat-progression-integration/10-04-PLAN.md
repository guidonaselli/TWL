---
phase: 10-combat-progression-integration
plan: 04
type: execute
wave: 3
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - TWL.Server/Simulation/Managers/CombatManager.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Services/PetService.cs
  - TWL.Server/Services/Combat/DeathPenaltyService.cs
  - TWL.Server/Simulation/Managers/StandardCombatResolver.cs
  - TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs
  - TWL.Tests/Server/QuestCombatIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Combat flow applies death penalties without breaking pet AI turn execution"
    - "Status effect processing remains stable while death/durability penalties are active"
    - "Movement and pet utility seams stay coherent with combat progression state"
  artifacts:
    - path: "TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs"
      provides: "End-to-end combat flow tests covering death penalties, pet turns, and status interactions"
      contains: "CombatFlowIntegrationTests"
    - path: "TWL.Server/Simulation/Networking/ClientSession.cs"
      provides: "Integrated pet utility action handling and movement modifier application path"
      contains: "HandlePetActionAsync|HandleMoveAsync"
    - path: "TWL.Server/Simulation/Managers/CombatManager.cs"
      provides: "Combat sequencing guards preserving stable behavior with new penalty hooks"
      contains: "OnCombatantDeath|Update"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Services/PetService.cs"
      via: "Pet utility requests routed from session to service"
      pattern: "PetActionType.Utility|UseUtility"
    - from: "TWL.Server/Simulation/Managers/CombatManager.cs"
      to: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      via: "Death event ordering remains compatible with penalty subscriber"
      pattern: "OnCombatantDeath"
---

<objective>
Integrate full Phase 10 combat flow (`CMB-04`) so death penalties, pet AI, skill/status behavior, and utility movement seams operate coherently.

Purpose: Remove integration gaps between independent subsystems now required to function together in production combat loops.
Output: Combat/session integration updates and cross-system integration tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-combat-progression-integration/10-RESEARCH.md
@.planning/phases/10-combat-progression-integration/10-01-PLAN.md
@.planning/phases/10-combat-progression-integration/10-02-PLAN.md
@.planning/phases/10-combat-progression-integration/10-03-PLAN.md

@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Services/PetService.cs
@TWL.Server/Simulation/Managers/StandardCombatResolver.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Close session utility/movement seams for integrated combat progression</name>
  <files>
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Services/PetService.cs
  </files>
  <action>
    1. Implement `PetActionType.Utility` handling in `HandlePetActionAsync` and route payload parsing to `PetService.UseUtility`.

    2. Apply `MoveSpeedModifier` in move processing (`HandleMoveAsync`) so mounted utility state has runtime movement effect.

    3. Ensure combat movement restrictions remain authoritative and unchanged while utility routing is expanded.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Utility actions and movement modifiers are functionally connected in runtime session flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate combat ordering with death penalties, status, and pet turns</name>
  <files>
    TWL.Server/Simulation/Managers/CombatManager.cs
    TWL.Server/Simulation/Managers/StandardCombatResolver.cs
    TWL.Server/Services/Combat/DeathPenaltyService.cs
  </files>
  <action>
    1. Confirm death event ordering does not break turn progression when penalties run.

    2. Ensure status effects and skill resolution behavior are not bypassed by new penalty hooks.

    3. Add minimal sequencing guards if needed to keep deterministic combat update flow.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Combat loop stays stable with death penalties active and pets/status effects participating normally.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cross-system integration tests for full combat flow</name>
  <files>
    TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs
    TWL.Tests/Server/QuestCombatIntegrationTests.cs
    TWL.Tests/PetTests/PetUtilityTests.cs
  </files>
  <action>
    1. Add integrated scenarios covering combat death -> EXP/durability penalties -> turn continuation behavior.

    2. Add scenarios combining pet AI actions, status effects, and death outcomes in same encounter.

    3. Add coverage verifying utility movement modifiers still function and do not bypass combat movement gates.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CombatFlowIntegrationTests|FullyQualifiedName~QuestCombatIntegrationTests|FullyQualifiedName~PetUtilityTests"`
  </verify>
  <done>
    Full combat flow is integration-tested across penalty, pet, status, and utility seams.
  </done>
</task>

</tasks>

<verification>
- [ ] Pet utility actions are routed from session handler
- [ ] Movement uses runtime speed modifier while preserving combat lock
- [ ] Death penalty hooks do not regress status/turn sequencing
- [ ] Cross-system combat integration tests pass
</verification>

<success_criteria>
- `CMB-04` integration requirement is implemented and regression-protected
- Combat progression behavior is coherent across core subsystems
</success_criteria>

<output>
After completion, create `.planning/phases/10-combat-progression-integration/10-04-SUMMARY.md`
</output>

---
phase: 10-combat-progression-integration
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - TWL.Server/Persistence/PlayerSaveData.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Server/Services/InstanceService.cs
  - TWL.Server/Services/World/Actions/Handlers/EnterInstanceActionHandler.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Tests/Server/Instances/InstanceRunLimitTests.cs
autonomous: true

must_haves:
  truths:
    - "Instance runs are tracked per character per instance with daily cap of 5"
    - "Run counters reset at 00:00 UTC and do not use local server timezone"
    - "Instance entry is rejected when daily quota is exhausted (5/5)"
  artifacts:
    - path: "TWL.Server/Services/InstanceService.cs"
      provides: "Instance admission policy enforcing daily run cap and UTC reset"
      contains: "TryEnterInstance|CanEnterInstance"
    - path: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      provides: "Per-instance run tracking state and reset helpers"
      contains: "InstanceRunCounters"
    - path: "TWL.Tests/Server/Instances/InstanceRunLimitTests.cs"
      provides: "Tests for cap enforcement, reset behavior, and rejection semantics"
      contains: "InstanceRunLimitTests"
  key_links:
    - from: "TWL.Server/Services/World/Actions/Handlers/EnterInstanceActionHandler.cs"
      to: "TWL.Server/Services/InstanceService.cs"
      via: "Enter-instance trigger path calls quota-aware admission API"
      pattern: "StartInstance|TryEnterInstance"
    - from: "TWL.Server/Services/InstanceService.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "Admission result emits success/rejection response to client contract"
      pattern: "SendAsync"
---

<objective>
Implement per-instance daily run limits with UTC reset and entry rejection to satisfy `INST-01`, `INST-02`, and `INST-03`.

Purpose: Prevent unlimited instance farming by enforcing server-authoritative daily quotas.
Output: Run-counter persistence model, quota-aware instance admission, and quota regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-combat-progression-integration/10-RESEARCH.md
@.planning/phases/10-combat-progression-integration/10-01-PLAN.md

@TWL.Server/Services/InstanceService.cs
@TWL.Server/Services/World/Actions/Handlers/EnterInstanceActionHandler.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Persistence/PlayerSaveData.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-instance daily run tracking model with UTC reset metadata</name>
  <files>
    TWL.Server/Persistence/PlayerSaveData.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add a run-counter model keyed by instance ID (count + reset marker such as next reset UTC midnight).

    2. Implement helper methods in `ServerCharacter` to evaluate/reset counters using `DateTime.UtcNow`.

    3. Keep backward compatibility with existing `InstanceLockouts` saves through migration defaults where needed.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Character state can persist and restore instance run counters with UTC reset semantics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce run-cap admission in instance entry flow</name>
  <files>
    TWL.Server/Services/InstanceService.cs
    TWL.Server/Services/World/Actions/Handlers/EnterInstanceActionHandler.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Replace/extend `StartInstance` flow with a quota-aware check (`count < 5`) before instance start.

    2. Increment run count on successful admission and reject entry at 5/5 with explicit response payload/message.

    3. Ensure rejection path is deterministic and does not consume a run.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Instance admission enforces daily cap and communicates rejection reliably.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add run-cap and UTC-reset regression tests</name>
  <files>
    TWL.Tests/Server/Instances/InstanceRunLimitTests.cs
    TWL.Server/Services/InstanceService.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add tests proving first five entries are accepted and sixth is rejected for same instance/day.

    2. Add tests proving reset occurs only at UTC midnight boundary.

    3. Add tests proving counters are per-instance (caps do not bleed across different instance IDs).
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~InstanceRunLimitTests"`
  </verify>
  <done>
    Instance lockout quota behavior is fully regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Runs are counted per character per instance
- [ ] Daily cap of 5 is enforced
- [ ] Reset logic is UTC-midnight based
- [ ] Entry rejection at 5/5 is surfaced to client flow
</verification>

<success_criteria>
- `INST-01`, `INST-02`, and `INST-03` are implemented and verified
- Instance run quotas are deterministic and persistence-safe
</success_criteria>

<output>
After completion, create `.planning/phases/10-combat-progression-integration/10-03-SUMMARY.md`
</output>


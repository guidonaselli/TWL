---
phase: 10-combat-progression-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/CombatManager.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Server/Services/Combat/DeathPenaltyService.cs
  - TWL.Server/Simulation/ServerWorker.cs
  - TWL.Tests/Server/Combat/DeathPenaltyServiceTests.cs
autonomous: true

must_haves:
  truths:
    - "Player death applies exactly 1% EXP loss based on current-level EXP, clamped at floor 0"
    - "Death penalties are server-authoritative and tied to combat death events, not client requests"
    - "Death processing is idempotent per death event and does not double-penalize"
  artifacts:
    - path: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      provides: "Dedicated combat death penalty coordinator subscribed to combat death events"
      contains: "class DeathPenaltyService"
    - path: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      provides: "Character-level EXP penalty mutation helper with clamp and dirty-state updates"
      contains: "ApplyDeathExperiencePenalty"
    - path: "TWL.Tests/Server/Combat/DeathPenaltyServiceTests.cs"
      provides: "Regression coverage for 1% EXP loss and no-double-apply behavior"
      contains: "DeathPenaltyServiceTests"
  key_links:
    - from: "TWL.Server/Simulation/Managers/CombatManager.cs"
      to: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      via: "OnCombatantDeath event subscription triggers death penalty policy"
      pattern: "OnCombatantDeath"
    - from: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      to: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      via: "Service invokes character EXP penalty mutation on player deaths"
      pattern: "ApplyDeathExperiencePenalty"
---

<objective>
Implement death-penalty EXP loss on player death (`CMB-01` partial) using server-authoritative combat event handling.

Purpose: Ensure combat deaths produce deterministic, policy-compliant progression penalties.
Output: DeathPenaltyService, ServerCharacter EXP penalty mutation, and focused regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-combat-progression-integration/10-RESEARCH.md

@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Simulation/ServerWorker.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add death-penalty service bound to combat death events</name>
  <files>
    TWL.Server/Services/Combat/DeathPenaltyService.cs
    TWL.Server/Simulation/ServerWorker.cs
    TWL.Server/Simulation/Managers/CombatManager.cs
  </files>
  <action>
    1. Create `DeathPenaltyService` that subscribes to `CombatManager.OnCombatantDeath` and filters only player-character deaths (not enemies, not pets).

    2. Keep behavior idempotent per death event to avoid duplicate EXP deductions from repeated callbacks or race conditions.

    3. Register/wire the service through startup composition so penalty handling is always active in runtime server flow.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Death penalties execute from a dedicated server module connected to combat death events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement EXP penalty mutation on ServerCharacter</name>
  <files>
    TWL.Server/Simulation/Networking/ServerCharacter.cs
    TWL.Server/Services/Combat/DeathPenaltyService.cs
  </files>
  <action>
    1. Add a character method (for example `ApplyDeathExperiencePenalty`) that deducts 1% of current level EXP with floor 0.

    2. Ensure mutation is thread-safe with existing progression locking and marks character dirty for persistence.

    3. Keep logic strictly scoped to current-level EXP (not total-level rollback) per phase requirement language.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Player death consistently applies correct EXP reduction semantics required by `CMB-01`.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add death-penalty regression tests</name>
  <files>
    TWL.Tests/Server/Combat/DeathPenaltyServiceTests.cs
    TWL.Server/Services/Combat/DeathPenaltyService.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add tests for baseline penalty math (1% of current-level EXP), floor clamp to 0, and no-penalty for non-player combatants.

    2. Add test for idempotency or duplicate-death-event protection.

    3. Validate that pet death handling continues to work independently (no behavioral regression against pet KO path).
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~DeathPenaltyServiceTests"`
  </verify>
  <done>
    EXP death penalty behavior is covered by automated regression tests.
  </done>
</task>

</tasks>

<verification>
- [ ] Combat death event triggers penalty service for player deaths
- [ ] EXP deduction is exactly 1% of current-level EXP with floor 0
- [ ] Non-player deaths are not mis-penalized
- [ ] Duplicate processing does not apply extra penalties
</verification>

<success_criteria>
- `CMB-01` EXP-loss component is implemented and test-backed
- Death penalty behavior is server-authoritative and deterministic
</success_criteria>

<output>
After completion, create `.planning/phases/10-combat-progression-integration/10-01-SUMMARY.md`
</output>


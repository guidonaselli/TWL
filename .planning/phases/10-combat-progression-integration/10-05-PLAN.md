---
phase: 10-combat-progression-integration
plan: 05
type: execute
wave: 4
depends_on: ["10-01", "10-02", "10-03", "10-04"]
files_modified:
  - TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs
  - TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs
  - TWL.Tests/Server/Instances/InstanceRunLimitTests.cs
  - TWL.Tests/Server/QuestCombatIntegrationTests.cs
  - .planning/phases/10-combat-progression-integration/10-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "All phase requirements CMB-01/02/03/04 and INST-01/02/03 are represented by executable acceptance tests"
    - "Acceptance tests validate exact policy values (1% EXP loss, -1 durability, 5/day cap, UTC reset)"
    - "Phase-level verification artifacts clearly map requirement IDs to passing checks"
  artifacts:
    - path: "TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs"
      provides: "Requirement-mapped acceptance suite for entire Phase 10 scope"
      contains: "CombatProgressionPhaseAcceptanceTests"
    - path: ".planning/phases/10-combat-progression-integration/10-VERIFICATION.md"
      provides: "Human-readable requirement-to-test evidence and residual risk notes"
      contains: "CMB-01|INST-03"
    - path: "TWL.Tests/Server/Instances/InstanceRunLimitTests.cs"
      provides: "Quota and UTC reset invariants kept under regression coverage"
      contains: "InstanceRunLimitTests"
  key_links:
    - from: "TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs"
      to: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      via: "Acceptance checks verify real death-penalty policy execution"
      pattern: "1%|durability"
    - from: "TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs"
      to: "TWL.Server/Services/InstanceService.cs"
      via: "Acceptance checks verify daily instance cap and rejection behavior"
      pattern: "5/5|UTC"
---

<objective>
Finalize Phase 10 with requirement-mapped acceptance verification and traceable evidence output.

Purpose: Ensure the phase is execution-ready and auditable against all roadmap requirements.
Output: Phase acceptance suite and verification artifact documenting requirement coverage.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-combat-progression-integration/10-RESEARCH.md
@.planning/phases/10-combat-progression-integration/10-01-PLAN.md
@.planning/phases/10-combat-progression-integration/10-02-PLAN.md
@.planning/phases/10-combat-progression-integration/10-03-PLAN.md
@.planning/phases/10-combat-progression-integration/10-04-PLAN.md

@TWL.Server/Services/Combat/DeathPenaltyService.cs
@TWL.Server/Services/InstanceService.cs
@TWL.Server/Simulation/Managers/CombatManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build phase acceptance suite mapped to CMB and INST requirements</name>
  <files>
    TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs
    TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs
    TWL.Tests/Server/Instances/InstanceRunLimitTests.cs
  </files>
  <action>
    1. Create acceptance tests explicitly labeled for `CMB-01`, `CMB-02`, `CMB-03`, `CMB-04`, `INST-01`, `INST-02`, `INST-03`.

    2. Assert exact requirement values: 1% EXP loss, durability -1 on all equipped items, broken-at-zero semantics, 5/day quota, UTC-midnight reset, rejection at 5/5.

    3. Reuse integration fixtures where possible to avoid redundant synthetic setup.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CombatProgressionPhaseAcceptanceTests"`
  </verify>
  <done>
    Phase requirements are encoded in executable acceptance checks with explicit ID mapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand cross-system regression checks for combat + instance interactions</name>
  <files>
    TWL.Tests/Server/Combat/CombatFlowIntegrationTests.cs
    TWL.Tests/Server/QuestCombatIntegrationTests.cs
    TWL.Tests/Server/Instances/InstanceRunLimitTests.cs
  </files>
  <action>
    1. Add scenarios combining combat death penalties and subsequent instance-entry attempts in same test flow.

    2. Add scenarios validating pet AI/status behavior remains consistent when death penalties are active.

    3. Ensure instance quota logic remains isolated from quest lockout timestamp semantics.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CombatFlowIntegrationTests|FullyQualifiedName~QuestCombatIntegrationTests|FullyQualifiedName~InstanceRunLimitTests"`
  </verify>
  <done>
    Regression suite covers realistic multi-system player flows for Phase 10.
  </done>
</task>

<task type="auto">
  <name>Task 3: Produce phase verification artifact</name>
  <files>
    .planning/phases/10-combat-progression-integration/10-VERIFICATION.md
    TWL.Tests/Server/Combat/CombatProgressionPhaseAcceptanceTests.cs
  </files>
  <action>
    1. Write `10-VERIFICATION.md` mapping each requirement ID to concrete test names and outcomes.

    2. Include any residual risks and clear follow-up actions if edge cases remain outside current test coverage.

    3. Ensure artifact is concise and executable-audit friendly for handoff to execution phase.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CombatProgressionPhaseAcceptanceTests|FullyQualifiedName~CombatFlowIntegrationTests|FullyQualifiedName~InstanceRunLimitTests"`
  </verify>
  <done>
    Verification evidence is explicit, auditable, and aligned with roadmap success criteria.
  </done>
</task>

</tasks>

<verification>
- [ ] All `CMB-*` and `INST-*` requirements have explicit acceptance tests
- [ ] Integration regressions pass for combat, pet/status, and instance flow
- [ ] Verification artifact maps requirements to tests and results
- [ ] Phase evidence is ready for execute-phase handoff
</verification>

<success_criteria>
- Phase 10 is fully acceptance-tested against roadmap requirements
- Execution handoff has requirement-traceable verification evidence
</success_criteria>

<output>
After completion, create `.planning/phases/10-combat-progression-integration/10-05-SUMMARY.md`
</output>


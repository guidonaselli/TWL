---
phase: 10-combat-progression-integration
plan: 02
type: execute
wave: 1
depends_on: ["10-01"]
files_modified:
  - TWL.Shared/Domain/Models/Item.cs
  - TWL.Server/Persistence/PlayerSaveData.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Server/Services/Combat/DeathPenaltyService.cs
  - TWL.Tests/Server/Equipment/DurabilitySystemTests.cs
autonomous: true

must_haves:
  truths:
    - "Every equipped item loses 1 durability when player death penalty is applied"
    - "Items at 0 durability are treated as Broken and no longer contribute stat effects"
    - "Durability and broken-state data persist through save/load without corrupting legacy saves"
  artifacts:
    - path: "TWL.Shared/Domain/Models/Item.cs"
      provides: "Durability and broken-state model fields with backward-compatible defaults"
      contains: "CurrentDurability|MaxDurability|IsBroken"
    - path: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      provides: "Equipment durability mutation and broken-item stat exclusion logic"
      contains: "ApplyEquipmentDeathDurabilityLoss"
    - path: "TWL.Tests/Server/Equipment/DurabilitySystemTests.cs"
      provides: "Regression tests for durability decrement and broken-state stat disable behavior"
      contains: "DurabilitySystemTests"
  key_links:
    - from: "TWL.Server/Services/Combat/DeathPenaltyService.cs"
      to: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      via: "Death penalty path triggers equipment durability decrement"
      pattern: "ApplyEquipmentDeathDurabilityLoss"
    - from: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      to: "TWL.Shared/Domain/Models/Item.cs"
      via: "Character stat computation reads item durability/broken metadata"
      pattern: "IsBroken"
---

<objective>
Implement durability and broken-state mechanics for equipped items to complete the non-EXP portion of `CMB-01` and all of `CMB-02`.

Purpose: Attach item wear to death penalties and enforce stat-disable semantics for broken gear.
Output: Item durability model, server durability mutation logic, and durability regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-combat-progression-integration/10-RESEARCH.md
@.planning/phases/10-combat-progression-integration/10-01-PLAN.md

@TWL.Shared/Domain/Models/Item.cs
@TWL.Server/Persistence/PlayerSaveData.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Services/Combat/DeathPenaltyService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend item model with durability and broken-state fields</name>
  <files>
    TWL.Shared/Domain/Models/Item.cs
    TWL.Server/Persistence/PlayerSaveData.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add durability fields to `Item` (for example `CurrentDurability`, `MaxDurability`, `IsBroken`) with safe defaults for legacy data.

    2. Ensure save/load payloads preserve new fields for inventory/equipment/bank where applicable.

    3. Keep JSON compatibility with existing item payloads so missing durability fields do not break deserialization.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Item durability metadata is persistable and backward-compatible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement equipment durability loss and broken-state effect suppression</name>
  <files>
    TWL.Server/Simulation/Networking/ServerCharacter.cs
    TWL.Server/Services/Combat/DeathPenaltyService.cs
  </files>
  <action>
    1. Add character-level mutation to reduce durability by 1 for all equipped items on death penalty execution.

    2. Mark equipment broken at 0 durability and enforce "no stat contribution when broken" in character stat calculations.

    3. Keep mutation thread-safe under character inventory/equipment locking and mark dirty for persistence.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Broken items are functionally disabled and durability loss is coupled to death penalties.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add durability and broken-state regression coverage</name>
  <files>
    TWL.Tests/Server/Equipment/DurabilitySystemTests.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
    TWL.Server/Services/Combat/DeathPenaltyService.cs
  </files>
  <action>
    1. Add tests proving each equipped item loses exactly 1 durability per death penalty application.

    2. Add tests proving 0-durability items become broken and do not apply stat modifiers.

    3. Add save/load round-trip tests to verify durability and broken-state persistence.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~DurabilitySystemTests"`
  </verify>
  <done>
    Durability and broken-state mechanics are protected by deterministic automated tests.
  </done>
</task>

</tasks>

<verification>
- [ ] Equipped items lose 1 durability on player death
- [ ] 0-durability items enter broken state
- [ ] Broken equipment does not contribute stat effects
- [ ] Durability data persists through save/load
</verification>

<success_criteria>
- `CMB-01` durability-loss component is implemented
- `CMB-02` broken-state semantics are implemented and test-backed
</success_criteria>

<output>
After completion, create `.planning/phases/10-combat-progression-integration/10-02-SUMMARY.md`
</output>


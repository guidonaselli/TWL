---
phase: 08-compound-system
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Shared/Domain/Interactions/InteractionDefinition.cs
  - TWL.Server/Simulation/Managers/InteractionManager.cs
  - Content/Data/interactions.json
  - TWL.Tests/Compound/CompoundNpcAccessTests.cs
autonomous: true

must_haves:
  truths:
    - "Players can access compound flow from configured compound NPC targets"
    - "Compound request rejects invalid base-item/material selections that do not exist in player inventory/equipment"
    - "Compound entry and request payloads are network-addressable via explicit opcodes"
  artifacts:
    - path: "TWL.Shared/Net/Network/Opcode.cs"
      provides: "Dedicated compound operation opcodes for open/request/result flow"
      contains: "CompoundOpenRequest"
    - path: "TWL.Server/Simulation/Networking/ClientSession.cs"
      provides: "Compound request handlers with ownership and inventory validation"
      contains: "HandleCompound"
    - path: "Content/Data/interactions.json"
      provides: "Compound NPC interaction definitions in live interaction content"
      contains: "Compound"
  key_links:
    - from: "Content/Data/interactions.json"
      to: "TWL.Server/Simulation/Managers/InteractionManager.cs"
      via: "compound NPC definitions are loaded and matched at interaction time"
      pattern: "TargetName|Type"
    - from: "TWL.Shared/Net/Network/Opcode.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "compound opcode dispatch routes into handler methods"
      pattern: "case Opcode.Compound"
---

<objective>
Implement compound NPC access and inventory selection validation pipeline.

Purpose: This delivers CMP-01 and CMP-02 by exposing a server-authoritative entry path for compound requests.
Output: Compound opcodes, session handlers, interaction definitions, and NPC-access/selection validation tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compound-system/08-RESEARCH.md
@.planning/phases/08-compound-system/08-01-PLAN.md

@TWL.Server/Simulation/Managers/InteractionManager.cs
@TWL.Server/Features/Interactions/InteractHandler.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Shared/Domain/Interactions/InteractionDefinition.cs
@Content/Data/interactions.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compound opcodes and client-session entry handlers</name>
  <files>
    TWL.Shared/Net/Network/Opcode.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Add compound-specific opcodes for opening compound UI and submitting compound requests.

    2. Implement handler skeletons in `ClientSession` that validate authenticated session, payload shape, and ownership constraints before invoking `ICompoundService`.

    3. Return explicit failure responses for invalid selection states (missing item, wrong slot, insufficient materials).
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Compound flow has explicit network entry points and server-side precondition validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend interaction definitions for compound NPC access</name>
  <files>
    TWL.Shared/Domain/Interactions/InteractionDefinition.cs
    TWL.Server/Simulation/Managers/InteractionManager.cs
    Content/Data/interactions.json
  </files>
  <action>
    1. Extend interaction definitions to support compound-capable NPC targets without breaking existing gather/craft/interact entries.

    2. Add compound NPC entries in `interactions.json` and ensure load/process behavior can resolve them safely.

    3. Keep interactions data-driven so phase execution can add new compound NPCs without code rewrites.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Players can enter compound flow from configured NPC targets through existing interaction pipeline.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add NPC access and material-selection validation tests</name>
  <files>
    TWL.Tests/Compound/CompoundNpcAccessTests.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Add tests covering valid compound-NPC access and rejection for non-compound interaction targets.

    2. Add tests that reject requests with invalid equipment references and insufficient materials.

    3. Verify handlers produce deterministic rejection reasons to simplify client UX and debugging.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CompoundNpcAccessTests"`
  </verify>
  <done>
    CMP-01 and CMP-02 access/selection behavior is regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Compound opcodes are present and routed by `ClientSession`
- [ ] Compound NPC entries are defined and processed by interaction manager
- [ ] Invalid base/material selections are rejected server-side
- [ ] NPC/access validation tests pass
</verification>

<success_criteria>
- CMP-01 implemented through compound NPC access pathway
- CMP-02 implemented through strict server validation of equipment/material selection
- Compound requests now enter a secure, deterministic server flow
</success_criteria>

<output>
After completion, create `.planning/phases/08-compound-system/08-02-SUMMARY.md`
</output>

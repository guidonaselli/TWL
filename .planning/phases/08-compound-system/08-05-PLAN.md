---
phase: 08-compound-system
plan: 05
type: execute
wave: 4
depends_on: ["08-04"]
files_modified:
  - TWL.Client/Presentation/Crafting/ForgeSystem.cs
  - TWL.Client/Presentation/Crafting/EquipmentData.cs
  - TWL.Client/Presentation/Managers/GameClientManager.cs
  - TWL.Client/Presentation/Managers/ClientInventoryManager.cs
  - TWL.Client/Presentation/Networking/NetworkClient.cs
  - TWL.Tests/Compound/CompoundClientIntegrationTests.cs
  - TWL.Tests/Compound/CompoundPhaseAcceptanceTests.cs
autonomous: true

must_haves:
  truths:
    - "Client compound UI/logic reflects server-authoritative outcomes instead of running local-only forge RNG"
    - "Player sees updated inventory/equipment enhancement state after compound responses"
    - "Phase-level compound requirements are covered by end-to-end acceptance tests"
  artifacts:
    - path: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      provides: "Client-side routing of compound network responses into inventory/equipment state"
      contains: "HandleCompound"
    - path: "TWL.Client/Presentation/Crafting/ForgeSystem.cs"
      provides: "Client adapter that requests compound from server rather than mutating authoritative state locally"
      contains: "RequestEnhance"
    - path: "TWL.Tests/Compound/CompoundPhaseAcceptanceTests.cs"
      provides: "Acceptance coverage mapping CMP-01 through CMP-06 behaviors"
      contains: "Cmp06_FeeIsNonRefundable"
  key_links:
    - from: "TWL.Client/Presentation/Networking/NetworkClient.cs"
      to: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      via: "compound response messages publish into client manager handlers"
      pattern: "Opcode.Compound"
    - from: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      to: "TWL.Client/Presentation/Managers/ClientInventoryManager.cs"
      via: "successful/failed compound outcomes update visible inventory/equipment state"
      pattern: "InventoryUpdate|CompoundResult"
---

<objective>
Finalize compound client integration and phase-level verification coverage.

Purpose: This closes the loop so Phase 8 is executable end-to-end and validated against CMP-01..CMP-06.
Output: Client server-driven compound flow integration plus integration/acceptance tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compound-system/08-RESEARCH.md
@.planning/phases/08-compound-system/08-04-PLAN.md

@TWL.Client/Presentation/Crafting/ForgeSystem.cs
@TWL.Client/Presentation/Managers/GameClientManager.cs
@TWL.Client/Presentation/Networking/NetworkClient.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire client forge flow to server-authoritative compound requests</name>
  <files>
    TWL.Client/Presentation/Crafting/ForgeSystem.cs
    TWL.Client/Presentation/Crafting/EquipmentData.cs
    TWL.Client/Presentation/Managers/GameClientManager.cs
  </files>
  <action>
    1. Replace local-only forge mutation flow with request/response integration using compound network contracts.

    2. Keep client responsibilities limited to selection, request dispatch, and presentation of server outcomes.

    3. Ensure local models can represent server-returned enhancement metadata and failure reason payloads.
  </action>
  <verify>
    `dotnet build TWL.Client/TWL.Client.csproj`
  </verify>
  <done>
    Client no longer acts as compound authority; it displays and routes server decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Route compound responses into client inventory/equipment state updates</name>
  <files>
    TWL.Client/Presentation/Managers/ClientInventoryManager.cs
    TWL.Client/Presentation/Networking/NetworkClient.cs
    TWL.Client/Presentation/Managers/GameClientManager.cs
  </files>
  <action>
    1. Add compound response message routing in network/client-manager pipeline.

    2. Update inventory/equipment manager behavior so compound outcomes are reflected in player-visible state.

    3. Keep update behavior resilient to out-of-order or duplicate responses by honoring operation id semantics.
  </action>
  <verify>
    `dotnet build TWL.Client/TWL.Client.csproj`
  </verify>
  <done>
    Compound outcomes are visible and consistent in client inventory/equipment views.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add client integration and phase acceptance tests</name>
  <files>
    TWL.Tests/Compound/CompoundClientIntegrationTests.cs
    TWL.Tests/Compound/CompoundPhaseAcceptanceTests.cs
  </files>
  <action>
    1. Add integration tests validating client/server contract handling for success and failure responses.

    2. Add phase acceptance tests explicitly mapping CMP-01..CMP-06 to executable checks.

    3. Include regressions for non-refundable fee behavior visibility and material/base-item outcome expectations.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CompoundClientIntegrationTests|FullyQualifiedName~CompoundPhaseAcceptanceTests"`
  </verify>
  <done>
    Phase 8 requirements have executable integration/acceptance coverage and client-side flow is server-driven.
  </done>
</task>

</tasks>

<verification>
- [ ] Client compound flow no longer depends on local RNG authority
- [ ] Compound responses update client inventory/equipment state
- [ ] CMP-01..CMP-06 acceptance tests exist and pass
- [ ] Compound integration tests pass
</verification>

<success_criteria>
- Phase 8 is execution-ready end-to-end with server-authoritative compound behavior
- Client compound UX is synchronized with server result contracts
- Phase-level requirement verification is encoded in repeatable tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-compound-system/08-05-SUMMARY.md`
</output>

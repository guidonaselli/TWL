---
phase: 08-compound-system
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - TWL.Server/Simulation/Managers/IEconomyService.cs
  - TWL.Server/Simulation/Managers/EconomyManager.cs
  - TWL.Server/Simulation/Managers/CompoundManager.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Shared/Domain/DTO/CompoundDTOs.cs
  - TWL.Tests/Compound/CompoundFeeIdempotencyTests.cs
autonomous: true

must_haves:
  truths:
    - "Each compound attempt charges a non-refundable fee before outcome resolution"
    - "Fee-charged compound operations are idempotent and reject duplicate replay from the same operation id"
    - "Economy logs make compound fee charges auditable and distinguishable from other economy operations"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      provides: "Compound fee charge path with non-refundable semantics and ledger logging"
      contains: "ChargeCompoundFee"
    - path: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      provides: "Compound execution integrates fee charging and operation-id idempotency gate"
      contains: "operationId"
    - path: "TWL.Tests/Compound/CompoundFeeIdempotencyTests.cs"
      provides: "Regression coverage for fee charging, replay protection, and no-refund outcomes"
      contains: "DuplicateOperationId_ShouldNotDoubleCharge"
  key_links:
    - from: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      to: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      via: "compound flow calls fee charge before success roll"
      pattern: "ChargeCompoundFee"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      via: "request operation id is forwarded into compound service for idempotency"
      pattern: "OperationId"
---

<objective>
Integrate non-refundable compound fee economics and anti-arbitrage safeguards.

Purpose: This delivers CMP-06 and hardens compound requests against replay and duplicate-charge inconsistencies.
Output: Economy fee extension, compound idempotency integration, session forwarding updates, and fee/idempotency tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compound-system/08-RESEARCH.md
@.planning/phases/08-compound-system/08-02-PLAN.md
@.planning/phases/08-compound-system/08-03-PLAN.md

@TWL.Server/Simulation/Managers/EconomyManager.cs
@TWL.Server/Simulation/Managers/IEconomyService.cs
@TWL.Server/Simulation/Managers/CompoundManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend economy service with explicit compound fee charging</name>
  <files>
    TWL.Server/Simulation/Managers/IEconomyService.cs
    TWL.Server/Simulation/Managers/EconomyManager.cs
  </files>
  <action>
    1. Add economy contract method for compound fee charging with operation id input and failure reason output.

    2. Implement fee debit + ledger logging path in `EconomyManager` with clear non-refundable semantics.

    3. Keep method behavior deterministic and reusable by compound manager.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Economy layer exposes auditable, non-refundable compound fee charging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce pre-roll fee and idempotency in compound execution path</name>
  <files>
    TWL.Server/Simulation/Managers/CompoundManager.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Shared/Domain/DTO/CompoundDTOs.cs
  </files>
  <action>
    1. Require operation id for compound apply requests and forward it from session handler to compound manager.

    2. Charge compound fee before success/failure roll and never refund fee for failed enhancement attempts.

    3. Add idempotent replay handling so repeated operation ids do not double-charge or double-apply outcomes.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Compound requests are fee-gated and replay-safe under retry conditions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add fee and idempotency regression tests</name>
  <files>
    TWL.Tests/Compound/CompoundFeeIdempotencyTests.cs
    TWL.Server/Simulation/Managers/CompoundManager.cs
    TWL.Server/Simulation/Managers/EconomyManager.cs
  </files>
  <action>
    1. Add tests proving fee is charged on both success and failure outcomes and is not refunded.

    2. Add tests proving duplicate operation ids do not cause duplicate fee debits or duplicate enhancement.

    3. Add test coverage for insufficient-funds and invalid-operation-id failure responses.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CompoundFeeIdempotencyTests"`
  </verify>
  <done>
    CMP-06 economics and replay hardening are regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Compound fee is charged before outcome resolution
- [ ] Fee is non-refundable on failed enhancement
- [ ] Operation id idempotency prevents duplicate charges/outcomes
- [ ] Fee/idempotency tests pass
</verification>

<success_criteria>
- CMP-06 implemented with non-refundable server-authoritative fee policy
- Compound operation economics align with anti-arbitrage design
- Retry/replay behavior is safe and deterministic
</success_criteria>

<output>
After completion, create `.planning/phases/08-compound-system/08-04-SUMMARY.md`
</output>

---
phase: 08-compound-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/ICompoundService.cs
  - TWL.Server/Simulation/Managers/CompoundManager.cs
  - TWL.Shared/Domain/DTO/CompoundDTOs.cs
  - TWL.Shared/Domain/Models/Item.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Server/Simulation/Program.cs
  - TWL.Tests/Compound/CompoundContractTests.cs
autonomous: true

must_haves:
  truths:
    - "Compound operations execute through a dedicated server-authoritative service, not client-local forge logic"
    - "Equipment enhancement metadata persists across save/load without losing level or bonus information"
    - "Compound service is registered in runtime DI and reachable by server handlers"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      provides: "Canonical compound domain service contract and baseline operation surface"
      contains: "class CompoundManager"
    - path: "TWL.Shared/Domain/DTO/CompoundDTOs.cs"
      provides: "Compound request/response payload contracts shared across server and client"
      contains: "CompoundApplyRequest"
    - path: "TWL.Shared/Domain/Models/Item.cs"
      provides: "Persistent enhancement metadata fields for compounded equipment"
      contains: "EnhanceLevel"
  key_links:
    - from: "TWL.Server/Simulation/Program.cs"
      to: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      via: "DI registration wires compound service into runtime"
      pattern: "AddSingleton<ICompoundService>"
    - from: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      to: "TWL.Shared/Domain/Models/Item.cs"
      via: "item cloning/save paths include enhancement metadata"
      pattern: "EnhanceLevel|EnhanceStatBonus"
---

<objective>
Create Phase 8 compound foundation contracts and persistence metadata.

Purpose: This establishes the server-authoritative base required for all compound NPC, formula, and fee mechanics.
Output: Compound service interface/manager, shared DTOs, enhancement item fields, DI wiring, and contract coverage tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compound-system/08-RESEARCH.md

@TWL.Shared/Domain/Models/Item.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compound domain service contracts and shared payload models</name>
  <files>
    TWL.Server/Simulation/Managers/ICompoundService.cs
    TWL.Server/Simulation/Managers/CompoundManager.cs
    TWL.Shared/Domain/DTO/CompoundDTOs.cs
  </files>
  <action>
    1. Add `ICompoundService` and `CompoundManager` with explicit operation surface for preview and apply flows.

    2. Define compound DTO contracts for selecting target equipment, material slots, operation id, and result payload fields.

    3. Keep DTO naming/style aligned with existing shared DTO conventions for `ClientSession` deserialization.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Compound service and payload contracts compile and represent authoritative server workflow inputs/outputs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enhancement metadata fields and persist them through character item flows</name>
  <files>
    TWL.Shared/Domain/Models/Item.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Extend `Item` with enhancement metadata fields needed for permanent compound outcomes.

    2. Update inventory/equipment/bank copy and save/load paths in `ServerCharacter` so enhancement data round-trips cleanly.

    3. Preserve backward compatibility with existing item serialization defaults.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` succeeds.
  </verify>
  <done>
    Enhancement metadata survives runtime copies and persistence reload without data loss.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register compound service and add baseline contract tests</name>
  <files>
    TWL.Server/Simulation/Program.cs
    TWL.Tests/Compound/CompoundContractTests.cs
  </files>
  <action>
    1. Register `ICompoundService` and `CompoundManager` in server DI composition.

    2. Add tests validating DTO serialization contract stability and service registration assumptions.

    3. Keep tests narrow to foundation-level behavior (contract + registration), not formula logic.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CompoundContractTests"`
  </verify>
  <done>
    Compound foundation is wired into runtime and protected by baseline contract tests.
  </done>
</task>

</tasks>

<verification>
- [ ] Compound service contracts exist and compile
- [ ] Enhancement metadata is persisted through `ServerCharacter` save/load paths
- [ ] Compound DI registration is present in `Program.cs`
- [ ] Foundation contract tests pass
</verification>

<success_criteria>
- CMP foundation is server-authoritative and ready for NPC/access/outcome mechanics
- Item enhancement metadata persistence is established for permanent bonuses
- Phase 8 can proceed with operation handlers and formula logic on stable contracts
</success_criteria>

<output>
After completion, create `.planning/phases/08-compound-system/08-01-SUMMARY.md`
</output>

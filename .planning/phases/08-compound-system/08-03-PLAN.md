---
phase: 08-compound-system
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - TWL.Server/Simulation/Managers/CompoundRatePolicy.cs
  - TWL.Server/Simulation/Managers/CompoundManager.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Tests/Compound/CompoundOutcomeTests.cs
autonomous: true

must_haves:
  truths:
    - "Success chance is calculated server-side from enhancement level and selected material bonuses"
    - "Successful compound attempts apply permanent enhancement bonuses to the target equipment"
    - "Failed attempts consume materials but preserve the base equipment item"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/CompoundRatePolicy.cs"
      provides: "Deterministic success-rate calculation policy with floor/ceiling rules"
      contains: "CalculateSuccessRate"
    - path: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      provides: "Compound execution engine that applies success/failure outcomes"
      contains: "TryCompound"
    - path: "TWL.Tests/Compound/CompoundOutcomeTests.cs"
      provides: "Regression tests for rate, success application, and failure-preserves-item behavior"
      contains: "Failure_ShouldConsumeMaterials_AndPreserveBaseItem"
  key_links:
    - from: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      to: "TWL.Server/Simulation/Managers/CompoundRatePolicy.cs"
      via: "compound execution calls rate policy before resolving outcome"
      pattern: "CalculateSuccessRate"
    - from: "TWL.Server/Simulation/Managers/CompoundManager.cs"
      to: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      via: "server updates material counts and equipment enhancement metadata atomically"
      pattern: "RemoveItem|Equipment"
---

<objective>
Implement compound success-rate and outcome engine.

Purpose: This delivers CMP-03, CMP-04, and CMP-05 with deterministic server-side compound resolution.
Output: Rate policy component, compound outcome application in manager, and outcome-focused regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-compound-system/08-RESEARCH.md
@.planning/phases/08-compound-system/08-01-PLAN.md

@TWL.Server/Simulation/Managers/CompoundManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement deterministic compound rate policy</name>
  <files>
    TWL.Server/Simulation/Managers/CompoundRatePolicy.cs
    TWL.Server/Simulation/Managers/CompoundManager.cs
  </files>
  <action>
    1. Add a dedicated rate-policy component that computes success chance from target enhancement level plus selected material bonuses.

    2. Enforce explicit min/max clamps so rates remain bounded and predictable.

    3. Ensure compound manager consumes policy output rather than inlining random formula logic.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    CMP-03 formula is centralized, deterministic, and server-authoritative.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply success/failure outcomes with base-item preservation</name>
  <files>
    TWL.Server/Simulation/Managers/CompoundManager.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Implement compound execution that always consumes selected materials once validation passes.

    2. On success, apply permanent enhancement metadata/stat bonuses to target equipment and emit quest-facing compound/forge notifications.

    3. On failure, preserve target equipment while still consuming materials and returning explicit outcome reason.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    CMP-04 and CMP-05 behavior is enforced in one authoritative compound execution path.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add outcome regression tests for success and failure paths</name>
  <files>
    TWL.Tests/Compound/CompoundOutcomeTests.cs
    TWL.Server/Simulation/Managers/CompoundManager.cs
  </files>
  <action>
    1. Add tests validating success-rate boundaries and correct success probability behavior inputs.

    2. Add tests proving success path mutates enhancement metadata and failure path does not destroy the base item.

    3. Validate material consumption behavior in both outcome branches.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CompoundOutcomeTests"`
  </verify>
  <done>
    Compound outcome semantics are test-backed for CMP-03/04/05.
  </done>
</task>

</tasks>

<verification>
- [ ] Success-rate calculation uses enhancement level + material bonuses with clamps
- [ ] Success applies permanent equipment enhancement metadata
- [ ] Failure consumes materials and preserves base item
- [ ] Outcome tests pass
</verification>

<success_criteria>
- CMP-03 implemented with deterministic server-side formula policy
- CMP-04 implemented with persistent bonus application on success
- CMP-05 implemented with guaranteed base-item preservation on failure
</success_criteria>

<output>
After completion, create `.planning/phases/08-compound-system/08-03-SUMMARY.md`
</output>

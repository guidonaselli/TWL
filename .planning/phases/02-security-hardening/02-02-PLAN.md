---
phase: 02-security-hardening
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - TWL.Server/Security/MovementValidationOptions.cs
  - TWL.Server/Security/MovementValidator.cs
  - TWL.Shared/Domain/DTO/MoveDTO.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Security/SecurityLogger.cs
  - TWL.Tests/Security/MovementValidatorTests.cs
  - TWL.Tests/Security/ClientSessionMovementValidationTests.cs
autonomous: true

must_haves:
  truths:
    - "Move requests exceeding max allowed distance per tick are rejected"
    - "Accepted move requests still update character position and trigger world systems"
    - "Rejected movement attempts generate security telemetry for investigation"
  artifacts:
    - path: "TWL.Server/Security/MovementValidator.cs"
      provides: "Server-authoritative move validation"
      contains: "class MovementValidator"
    - path: "TWL.Server/Simulation/Networking/ClientSession.cs"
      provides: "Movement gate integrated into HandleMoveAsync"
      contains: "HandleMoveAsync"
    - path: "TWL.Tests/Security/MovementValidatorTests.cs"
      provides: "Regression coverage for speed-hack and teleport payloads"
      contains: "MovementValidatorTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Security/MovementValidator.cs"
      via: "validate before mutating Character.X/Y"
      pattern: "_movementValidator"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Security/SecurityLogger.cs"
      via: "log rejection with reason"
      pattern: "MoveValidationRejected"
---

<objective>
Implement server-side movement validation to block speed-hack and teleport-style movement payloads.

Purpose: This plan delivers SEC-01 by moving movement trust fully to the server with deterministic checks.
Output: Movement validator with policy controls, ClientSession integration, and tests proving valid vs invalid movement behavior.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md
@.planning/phases/02-security-hardening/02-01-PLAN.md

@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Shared/Domain/DTO/MoveDTO.cs
@TWL.Server/Security/SecurityLogger.cs
@TWL.Server/Simulation/Managers/SpawnManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create movement validation policy and validator service</name>
  <files>
    TWL.Server/Security/MovementValidationOptions.cs
    TWL.Server/Security/MovementValidator.cs
    TWL.Shared/Domain/DTO/MoveDTO.cs
  </files>
  <action>
    1. Add `MovementValidationOptions` with explicit limits:
       - `MaxDistancePerTick`
       - `MaxAxisDeltaPerTick`
       - `AllowDiagonalBoost` strategy
       - optional `MaxAbsoluteCoordinate` safety cap

    2. Add `MovementValidator` API like:
       - `Validate(currentX, currentY, moveDto, deltaTime, out reason)`

    3. Validation must reject at least:
       - NaN/infinite delta values
       - deltas above configured per-tick magnitude
       - malformed payloads missing required fields

    4. Keep `MoveDTO` compatible with current clients; only add metadata fields if strictly required by validator logic.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` succeeds and validator unit tests compile.
  </verify>
  <done>
    A reusable movement validator exists with policy-driven limits and deterministic pass/fail reasons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce movement validation in ClientSession before mutating character position</name>
  <files>
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Security/SecurityLogger.cs
  </files>
  <action>
    1. Integrate `MovementValidator` in `HandleMoveAsync`:
       - validate payload before updating `Character.X`/`Character.Y`
       - on reject, return early with security event (`MoveValidationRejected`) including reason and move vector

    2. Preserve existing movement side effects for accepted moves:
       - world trigger checks
       - spawn/encounter distance accounting

    3. Ensure rejection path does not mutate player position or trigger spawn calculations.

    4. Add clear logging details (userId, map, old/new attempted positions, reason) without leaking sensitive data.
  </action>
  <verify>
    Run targeted tests and verify accepted moves still call encounter path while rejected moves do not mutate coordinates.
  </verify>
  <done>
    ClientSession applies movement only after server validation and logs all rejected suspicious movement payloads.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for speed-hack, teleport, and valid movement scenarios</name>
  <files>
    TWL.Tests/Security/MovementValidatorTests.cs
    TWL.Tests/Security/ClientSessionMovementValidationTests.cs
  </files>
  <action>
    1. Add validator tests covering:
       - valid small movement accepted
       - oversized axis/magnitude movement rejected
       - NaN/infinite values rejected

    2. Add session-level behavior tests covering:
       - rejected movement leaves `Character.X/Y` unchanged
       - accepted movement updates position and continues flow

    3. Include at least one test proving movement rejection is observable through security logging/event hooks.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~Movement"` passes.
  </verify>
  <done>
    Regression tests reliably fail if movement hardening is removed or weakened.
  </done>
</task>

</tasks>

<verification>
- [ ] `dotnet build TWL.Server/TWL.Server.csproj` succeeds
- [ ] Movement-focused tests pass
- [ ] Invalid move payloads do not mutate player position
- [ ] Rejection events are logged with actionable reason codes
</verification>

<success_criteria>
- SEC-01 is enforced by server-side movement policy
- Speed-hack and teleport-like payloads are rejected deterministically
- Legitimate movement remains functional and covered by tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-02-SUMMARY.md`
</output>

---
phase: 02-security-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Persistence/Database/DbService.cs
  - TWL.Server/Security/Idempotency/OperationRecord.cs
  - TWL.Server/Security/Idempotency/IdempotencyValidator.cs
  - TWL.Server/Simulation/Managers/EconomyManager.cs
  - TWL.Server/Simulation/Managers/TradeManager.cs
  - TWL.Server/Simulation/Managers/IEconomyService.cs
  - TWL.Tests/Security/IdempotencyValidatorTests.cs
  - TWL.Tests/Security/EconomyIdempotencyFlowTests.cs
  - TWL.Tests/Security/SerializableTransactionPolicyTests.cs
autonomous: true

must_haves:
  truths:
    - "A valuable operation retried with the same operation key executes only once"
    - "Valuable multi-party operations run through a Serializable transaction boundary"
    - "Trade and economy operation logs contain operation identity for audit and replay analysis"
  artifacts:
    - path: "TWL.Server/Security/Idempotency/IdempotencyValidator.cs"
      provides: "Shared idempotency validation and replay-safe decisioning"
      contains: "class IdempotencyValidator"
    - path: "TWL.Server/Persistence/Database/DbService.cs"
      provides: "Reusable Serializable transaction helper"
      contains: "IsolationLevel.Serializable"
    - path: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      provides: "Economy operations aligned to shared idempotency/transaction policy"
      contains: "operationId"
  key_links:
    - from: "TWL.Server/Simulation/Managers/EconomyManager.cs"
      to: "TWL.Server/Security/Idempotency/IdempotencyValidator.cs"
      via: "operation-key deduplication before side effects"
      pattern: "Idempotency"
    - from: "TWL.Server/Simulation/Managers/TradeManager.cs"
      to: "TWL.Server/Persistence/Database/DbService.cs"
      via: "serializable execution boundary for valuable transfer"
      pattern: "Serializable"
---

<objective>
Establish shared idempotency and Serializable transaction foundations for valuable multi-party operations.

Purpose: This plan delivers SEC-03 and SEC-04 in a reusable way that Phase 7 market and Phase 5 guild-bank flows can consume without redesign.
Output: DbService transaction helper, shared idempotency validator, and manager integrations/tests proving duplicate-safe execution semantics.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-RESEARCH.md

@TWL.Server/Persistence/Database/DbService.cs
@TWL.Server/Simulation/Managers/EconomyManager.cs
@TWL.Server/Simulation/Managers/IEconomyService.cs
@TWL.Server/Simulation/Managers/TradeManager.cs
@TWL.Server/Security/SecurityLogger.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Serializable transaction execution helper in DbService</name>
  <files>
    TWL.Server/Persistence/Database/DbService.cs
  </files>
  <action>
    1. Add reusable helper APIs in `DbService` for valuable operations, for example:
       - `ExecuteSerializableAsync(Func<NpgsqlConnection, NpgsqlTransaction, Task<T>> work)`

    2. Ensure helper behavior:
       - opens connection
       - begins transaction with `IsolationLevel.Serializable`
       - commits on success
       - rolls back on exception
       - preserves existing login/health APIs unchanged

    3. Add minimal telemetry hooks/logging for transaction failures to support operational triage.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` succeeds and transaction helper compiles with async call sites.
  </verify>
  <done>
    DbService exposes a reusable Serializable execution boundary for market/trade/guild-bank style operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared idempotency validator and align economy/transaction entry points</name>
  <files>
    TWL.Server/Security/Idempotency/OperationRecord.cs
    TWL.Server/Security/Idempotency/IdempotencyValidator.cs
    TWL.Server/Simulation/Managers/EconomyManager.cs
    TWL.Server/Simulation/Managers/IEconomyService.cs
  </files>
  <action>
    1. Add reusable idempotency artifacts under `TWL.Server/Security/Idempotency`:
       - operation status model (pending/completed/failed)
       - validator that classifies operation keys as new/replay/in-flight

    2. Refactor `EconomyManager` operation-key paths to use shared idempotency validator instead of ad-hoc duplicate checks.

    3. Standardize operation key requirements for valuable operations:
       - operation key required where retries can mutate value
       - duplicate key returns idempotent success with original semantic result

    4. Keep existing public behavior compatible for current callers unless strict mode is explicitly enabled.
  </action>
  <verify>
    Build and run targeted tests for economy idempotency behavior; duplicate requests should not double-apply side effects.
  </verify>
  <done>
    Economy operations use a common idempotency model with explicit duplicate/in-flight semantics.
  </done>
</task>

<task type="auto">
  <name>Task 3: Prepare TradeManager for operation-key + Serializable policy and add regression tests</name>
  <files>
    TWL.Server/Simulation/Managers/TradeManager.cs
    TWL.Tests/Security/IdempotencyValidatorTests.cs
    TWL.Tests/Security/EconomyIdempotencyFlowTests.cs
    TWL.Tests/Security/SerializableTransactionPolicyTests.cs
  </files>
  <action>
    1. Introduce operation-key aware trade entry path (new overload or adapter) that can be consumed by future market/guild-bank orchestrators.

    2. Ensure trade and economy paths emit audit details containing operation identity and correlation metadata.

    3. Add tests covering:
       - duplicate operation key does not duplicate state mutation
       - in-flight operation key behavior is deterministic
       - Serializable transaction helper is selected for valuable transaction path (policy test)

    4. Keep existing TradeManager transfer semantics and bind-policy hardening intact.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~Idempotency|FullyQualifiedName~Serializable"` passes.
  </verify>
  <done>
    Trade/economy valuable-operation paths are idempotent-ready and serializable-policy tested for future market integration.
  </done>
</task>

</tasks>

<verification>
- [ ] `dotnet build TWL.Server/TWL.Server.csproj` succeeds
- [ ] Idempotency and serializable-policy tests pass
- [ ] Duplicate operation keys do not double-apply value mutations
- [ ] Valuable operations route through serializable transaction helper
</verification>

<success_criteria>
- SEC-03 foundation exists via reusable Serializable transaction execution helper
- SEC-04 foundation exists via shared operation-key idempotency logic
- Economy/trade paths are aligned to reusable security patterns instead of isolated implementations
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-03-SUMMARY.md`
</output>

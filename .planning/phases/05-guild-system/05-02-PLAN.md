---
phase: 05-guild-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - TWL.Server/Simulation/Managers/GuildPermissionService.cs
  - TWL.Server/Simulation/Managers/GuildManager.cs
  - TWL.Shared/Domain/DTO/GuildRankDTOs.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Tests/Guild/GuildRankHierarchyTests.cs
  - TWL.Tests/Guild/GuildPermissionsTests.cs
autonomous: true

must_haves:
  truths:
    - "Guilds support hierarchical ranks with explicit permission sets"
    - "Only authorized ranks can invite, promote, kick, and grant storage withdrawal access"
    - "Rank changes are validated server-side and synchronized to guild members"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/GuildPermissionService.cs"
      provides: "Centralized permission evaluation for guild actions"
      contains: "CanInvite|CanPromote|CanKick|CanWithdraw"
    - path: "TWL.Server/Simulation/Managers/GuildManager.cs"
      provides: "Guild rank hierarchy and member role mutation operations"
      contains: "Promote|Demote|SetRank"
    - path: "TWL.Tests/Guild/GuildPermissionsTests.cs"
      provides: "Permission matrix regression checks for sensitive guild actions"
      contains: "GuildPermissionsTests"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/GuildPermissionService.cs"
      via: "incoming privileged guild commands pass through permission checks"
      pattern: "GuildPromote|GuildDemote|GuildKick|GuildInvite"
    - from: "TWL.Server/Simulation/Managers/GuildManager.cs"
      to: "TWL.Server/Simulation/Networking/ServerCharacter.cs"
      via: "rank and membership updates remain consistent with character guild identity"
      pattern: "GuildId|GuildRank"
---

<objective>
Implement guild rank hierarchy and permission enforcement for privileged guild operations.

Purpose: This delivers GLD-04 and provides the security policy baseline required by chat moderation and guild storage access.
Output: Permission service + rank DTOs + promote/demote handlers + deterministic rank/permission tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-guild-system/05-RESEARCH.md
@.planning/phases/05-guild-system/05-01-PLAN.md

@TWL.Server/Simulation/Managers/GuildManager.cs
@TWL.Server/Simulation/Managers/TradeManager.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Shared/Net/Network/Opcode.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rank hierarchy and permission matrix contracts</name>
  <files>
    TWL.Server/Simulation/Managers/GuildPermissionService.cs
    TWL.Server/Simulation/Managers/GuildManager.cs
    TWL.Shared/Domain/DTO/GuildRankDTOs.cs
  </files>
  <action>
    1. Define guild rank model (leader/officer/member/recruit baseline) and permission flags for:
       - invite
       - promote/demote
       - kick
       - storage withdraw

    2. Add `GuildPermissionService` to evaluate permissions from canonical guild rank state.

    3. Extend `GuildManager` with rank mutation operations that enforce hierarchy constraints (cannot self-demote leader into invalid state, cannot promote beyond caller authority).
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Rank hierarchy and permission logic are centralized and callable from all guild operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce rank permissions in network guild actions</name>
  <files>
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Shared/Net/Network/Opcode.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Add/extend guild rank opcodes and handler paths for promote/demote/permission-sensitive actions.

    2. Route all privileged guild actions through `GuildPermissionService`; return explicit deny reasons for unauthorized calls.

    3. Ensure server-side rank state is reflected in outgoing guild membership updates so client and server remain consistent.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildPermissionsTests|FullyQualifiedName~GuildRankHierarchyTests"`
  </verify>
  <done>
    Privileged guild actions are blocked unless rank permissions authorize them.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add rank hierarchy and permission regression tests</name>
  <files>
    TWL.Tests/Guild/GuildRankHierarchyTests.cs
    TWL.Tests/Guild/GuildPermissionsTests.cs
  </files>
  <action>
    1. Add hierarchy tests for valid/invalid promotion and demotion transitions.

    2. Add permission matrix tests for invite, kick, promote, and withdraw actions across rank combinations.

    3. Include negative-path assertions for unauthorized operations and stale-rank race scenarios.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildRankHierarchyTests|FullyQualifiedName~GuildPermissionsTests"`
  </verify>
  <done>
    Rank and permission behavior is deterministic and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Rank hierarchy enforces valid promotion/demotion boundaries
- [ ] Privileged guild actions are rejected when rank permissions are missing
- [ ] Authorized actions succeed and propagate updated rank state
- [ ] Guild rank/permission tests pass
</verification>

<success_criteria>
- GLD-04 is implemented with server-authoritative permission checks
- Guild command authorization is centralized and test-backed
- Phase 5 is ready for chat/roster and storage plans that depend on permissions
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-system/05-02-SUMMARY.md`
</output>

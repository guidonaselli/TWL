---
phase: 05-guild-system
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - TWL.Server/Simulation/Managers/GuildStorageService.cs
  - TWL.Server/Simulation/Managers/GuildAuditLogService.cs
  - TWL.Server/Simulation/Managers/GuildManager.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Shared/Domain/DTO/GuildStorageDTOs.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Tests/Guild/GuildStoragePermissionTests.cs
  - TWL.Tests/Guild/GuildWithdrawalGateTests.cs
  - TWL.Tests/Guild/GuildStorageAuditTests.cs
autonomous: true

must_haves:
  truths:
    - "Guild members can deposit into shared storage while withdrawals are permission-gated"
    - "New guild members cannot withdraw until configured tenure window elapses"
    - "Every guild storage withdrawal produces immutable audit records with who/what/when"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/GuildStorageService.cs"
      provides: "Authoritative guild storage deposit/withdraw operations and policy enforcement"
      contains: "class GuildStorageService"
    - path: "TWL.Server/Simulation/Managers/GuildAuditLogService.cs"
      provides: "Append-only audit trail for guild storage withdrawals"
      contains: "AppendWithdrawalEntry"
    - path: "TWL.Shared/Domain/DTO/GuildStorageDTOs.cs"
      provides: "Guild storage request/response and audit payload contracts"
      contains: "GuildWithdrawRequest"
  key_links:
    - from: "TWL.Server/Simulation/Managers/GuildStorageService.cs"
      to: "TWL.Server/Simulation/Managers/GuildPermissionService.cs"
      via: "withdraw authorization uses rank permission checks"
      pattern: "CanWithdraw"
    - from: "TWL.Server/Simulation/Managers/GuildStorageService.cs"
      to: "TWL.Server/Simulation/Managers/GuildAuditLogService.cs"
      via: "successful and denied withdrawal attempts record auditable events"
      pattern: "Audit|Withdrawal"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Simulation/Managers/GuildStorageService.cs"
      via: "storage opcodes dispatch to guild storage operations"
      pattern: "GuildStorageDeposit|GuildStorageWithdraw|GuildStorageView"
---

<objective>
Implement guild shared storage with permission controls, withdrawal tenure gating, and auditable withdrawal history.

Purpose: This delivers GLD-06, GLD-07, and GLD-08 and protects guild bank assets from abuse.
Output: Guild storage service + audit logging service + storage DTO/opcodes + deterministic storage policy tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-guild-system/05-RESEARCH.md
@.planning/phases/05-guild-system/05-01-PLAN.md
@.planning/phases/05-guild-system/05-02-PLAN.md

@TWL.Server/Simulation/Managers/EconomyManager.cs
@TWL.Server/Simulation/Managers/TradeManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild storage domain model and network contracts</name>
  <files>
    TWL.Server/Simulation/Managers/GuildStorageService.cs
    TWL.Server/Simulation/Managers/GuildManager.cs
    TWL.Shared/Domain/DTO/GuildStorageDTOs.cs
    TWL.Shared/Net/Network/Opcode.cs
  </files>
  <action>
    1. Add `GuildStorageService` with canonical guild vault model and operations:
       - view vault
       - deposit item
       - withdraw item

    2. Define storage DTOs/opcodes for requests, responses, and storage update broadcasts.

    3. Ensure storage mutation uses exact item policy matching and deterministic mutation semantics (no partial silent failures).
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Guild storage operations exist as server-authoritative contracts with transport coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce withdraw permissions, tenure gate, and idempotent withdrawal handling</name>
  <files>
    TWL.Server/Simulation/Managers/GuildStorageService.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
  </files>
  <action>
    1. Enforce rank-based withdraw authorization through guild permission checks.

    2. Add configurable join-tenure gate (default 14 days) before withdrawal is allowed for new members.

    3. Add operation-id based idempotency for withdrawal requests to prevent replay/duplicate withdrawal outcomes.

    4. Wire storage operations in `ClientSession` handlers with explicit rejection reasons for permission or tenure failures.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildStoragePermissionTests|FullyQualifiedName~GuildWithdrawalGateTests"`
  </verify>
  <done>
    Withdrawal policy is enforced server-side and replay-safe.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add append-only guild storage audit logging and regression tests</name>
  <files>
    TWL.Server/Simulation/Managers/GuildAuditLogService.cs
    TWL.Server/Simulation/Managers/GuildStorageService.cs
    TWL.Tests/Guild/GuildStorageAuditTests.cs
    TWL.Tests/Guild/GuildStoragePermissionTests.cs
    TWL.Tests/Guild/GuildWithdrawalGateTests.cs
  </files>
  <action>
    1. Add `GuildAuditLogService` for append-only withdrawal audit entries that capture actor, guild, item, quantity, timestamp, and result status.

    2. Ensure both successful and rejected withdrawals are auditable for abuse investigation.

    3. Add tests proving:
       - authorized withdrawals are logged correctly
       - blocked withdrawals (permission/tenure) are logged with denial reason
       - storage inventory remains consistent after failed operations.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildStorageAuditTests|FullyQualifiedName~GuildStoragePermissionTests|FullyQualifiedName~GuildWithdrawalGateTests"`
  </verify>
  <done>
    Guild storage withdrawal behavior is auditable and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Guild storage deposit/withdraw routes through server-authoritative handlers
- [ ] Withdrawals require both rank permission and tenure gate compliance
- [ ] Withdrawal requests are idempotent per operation id
- [ ] Audit log captures successful and denied withdrawals with reason
</verification>

<success_criteria>
- GLD-06, GLD-07, and GLD-08 are implemented with abuse-resistant controls
- Guild bank assets are protected by permission and tenure policy
- Withdrawal traceability exists for operations and investigations
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-system/05-04-SUMMARY.md`
</output>

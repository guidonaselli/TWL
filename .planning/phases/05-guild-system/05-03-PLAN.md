---
phase: 05-guild-system
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - TWL.Server/Simulation/Managers/GuildChatService.cs
  - TWL.Server/Simulation/Managers/GuildRosterService.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Persistence/Services/PlayerService.cs
  - TWL.Shared/Domain/DTO/GuildChatDTOs.cs
  - TWL.Shared/Domain/DTO/GuildRosterDTOs.cs
  - TWL.Client/Presentation/Managers/GameClientManager.cs
  - TWL.Client/Presentation/UI/UiGuildWindow.cs
  - TWL.Tests/Guild/GuildChatChannelTests.cs
  - TWL.Tests/Guild/GuildRosterSyncTests.cs
autonomous: true

must_haves:
  truths:
    - "Guild chat is visible only to guild members and survives offline member periods"
    - "Guild roster shows member rank, online status, and last-login metadata"
    - "Client guild UI reflects roster and chat updates without stale cross-guild leakage"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/GuildChatService.cs"
      provides: "Server-authoritative guild chat routing and offline message persistence"
      contains: "class GuildChatService"
    - path: "TWL.Server/Simulation/Managers/GuildRosterService.cs"
      provides: "Guild roster projection with rank and presence information"
      contains: "class GuildRosterService"
    - path: "TWL.Client/Presentation/UI/UiGuildWindow.cs"
      provides: "Client guild panel for roster and guild chat presentation"
      contains: "class UiGuildWindow"
  key_links:
    - from: "TWL.Server/Simulation/Managers/GuildChatService.cs"
      to: "TWL.Server/Persistence/Services/PlayerService.cs"
      via: "online-session lookup and offline backlog persistence share canonical member identity"
      pattern: "GetSession|SaveSession|LastSeenAt"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Client/Presentation/Managers/GameClientManager.cs"
      via: "guild chat and roster update payloads are consumed by client state"
      pattern: "GuildChat|GuildRoster"
---

<objective>
Implement guild communication and roster visibility, including offline-safe chat persistence and client sync.

Purpose: This delivers GLD-05 and GLD-09 so guilds become an operational social channel rather than a hidden server-only structure.
Output: Guild chat + roster services, DTO contracts, client guild UI integration, and deterministic roster/chat tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-guild-system/05-RESEARCH.md
@.planning/phases/05-guild-system/05-01-PLAN.md
@.planning/phases/05-guild-system/05-02-PLAN.md

@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Persistence/Services/PlayerService.cs
@TWL.Client/Presentation/Managers/GameClientManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild chat service and payload contracts with offline persistence</name>
  <files>
    TWL.Server/Simulation/Managers/GuildChatService.cs
    TWL.Shared/Domain/DTO/GuildChatDTOs.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Add `GuildChatService` to broadcast messages only to active sessions in the same guild.

    2. Persist guild chat backlog for offline members with bounded retention (configurable max count or age).

    3. Add guild chat DTOs for send, broadcast, and backlog delivery events; wire handlers in `ClientSession`.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Guild chat is server-scoped by guild membership and supports offline catch-up.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement guild roster projection with rank, online status, and last login</name>
  <files>
    TWL.Server/Simulation/Managers/GuildRosterService.cs
    TWL.Shared/Domain/DTO/GuildRosterDTOs.cs
    TWL.Server/Persistence/Services/PlayerService.cs
  </files>
  <action>
    1. Add a `GuildRosterService` that emits canonical roster snapshots and delta updates.

    2. Extend player persistence/session metadata with last-login/last-seen data required for guild roster rendering.

    3. Include rank, online flag, and last-login timestamp in roster DTO contracts for client consumption.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildRosterSyncTests"`
  </verify>
  <done>
    Guild roster payloads include required member metadata and remain consistent across reconnects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate guild UI state and add roster/chat isolation tests</name>
  <files>
    TWL.Client/Presentation/Managers/GameClientManager.cs
    TWL.Client/Presentation/UI/UiGuildWindow.cs
    TWL.Tests/Guild/GuildChatChannelTests.cs
    TWL.Tests/Guild/GuildRosterSyncTests.cs
  </files>
  <action>
    1. Add client-side guild state handling in `GameClientManager` for roster and chat streams.

    2. Add `UiGuildWindow` and connect it to gameplay UI for roster list, rank display, online indicator, and guild chat feed.

    3. Add tests validating:
       - chat visibility isolation by guild
       - roster sync on join/leave/rank-change/login-state changes
       - no stale members after guild transition.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~GuildChatChannelTests|FullyQualifiedName~GuildRosterSyncTests"`
  </verify>
  <done>
    Guild roster and chat are live in client UX and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Guild chat is isolated per guild and supports offline backlog delivery
- [ ] Roster payload includes rank, online status, and last login
- [ ] Client guild UI updates on membership/rank/presence changes
- [ ] Guild chat/roster tests pass
</verification>

<success_criteria>
- GLD-05 and GLD-09 are implemented with server-authoritative sync
- Guild communication and roster visibility are usable and test-backed
- Guild client state stays consistent across reconnect and membership changes
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-system/05-03-SUMMARY.md`
</output>

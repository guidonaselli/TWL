---
phase: 06-rebirth-system
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - TWL.Server/Simulation/Networking/ServerPet.cs
  - TWL.Server/Services/PetService.cs
  - TWL.Shared/Services/IPetService.cs
  - TWL.Shared/Domain/Characters/PetDefinition.cs
  - TWL.Shared/Domain/Requests/PetActionRequest.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Tests/PetTests/PetRebirthPolicyTests.cs
  - TWL.Tests/PetTests/PetRebirthEvolutionTests.cs
autonomous: true

must_haves:
  truths:
    - "Quest pets can rebirth/evolve while capturable pets are rejected from rebirth"
    - "Pet rebirth applies generation-based diminishing stat bonuses using 10/8/5 schedule"
    - "Pet rebirth and evolution outcomes are accessible through explicit server action routing"
  artifacts:
    - path: "TWL.Server/Simulation/Networking/ServerPet.cs"
      provides: "Pet rebirth generation logic, eligibility checks, and evolution transitions"
      contains: "TryRebirth"
    - path: "TWL.Server/Services/PetService.cs"
      provides: "Server-authoritative pet rebirth policy enforcement and orchestration"
      contains: "TryRebirth"
    - path: "TWL.Shared/Domain/Requests/PetActionRequest.cs"
      provides: "Pet action contract includes explicit rebirth action type"
      contains: "PetActionType"
  key_links:
    - from: "TWL.Shared/Domain/Requests/PetActionRequest.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "pet rebirth action routes into service operation handlers"
      pattern: "Rebirth"
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Server/Services/PetService.cs"
      via: "pet rebirth request uses canonical pet service eligibility and mutation logic"
      pattern: "TryRebirth"
    - from: "TWL.Server/Services/PetService.cs"
      to: "TWL.Server/Simulation/Networking/ServerPet.cs"
      via: "service delegates to pet domain rebirth generation/evolution behavior"
      pattern: "TryRebirth|Generation"
---

<objective>
Complete pet rebirth policy for Phase 6, including eligibility differentiation and diminishing rebirth progression.

Purpose: This delivers PET-03 and PET-04 using the same safety principles established for character rebirth.
Output: Upgraded pet rebirth domain/service logic + action routing + deterministic pet rebirth/evolution tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rebirth-system/06-RESEARCH.md
@.planning/phases/06-rebirth-system/06-01-PLAN.md

@TWL.Server/Simulation/Networking/ServerPet.cs
@TWL.Server/Services/PetService.cs
@TWL.Shared/Domain/Characters/PetDefinition.cs
@TWL.Shared/Domain/Requests/PetActionRequest.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade pet rebirth domain model for generation-based policy</name>
  <files>
    TWL.Server/Simulation/Networking/ServerPet.cs
    TWL.Shared/Domain/Characters/PetDefinition.cs
  </files>
  <action>
    1. Extend pet rebirth state from one-time boolean behavior to generation-aware progression.

    2. Implement diminishing bonus schedule for pet rebirth generations:
       - rebirth 1: +10
       - rebirth 2: +8
       - rebirth 3+: +5

    3. Include evolution transition support tied to rebirth generation/definition metadata where configured.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Pet rebirth supports generation-aware diminishing bonuses and evolution metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce quest-vs-capturable rebirth policy and wire action routing</name>
  <files>
    TWL.Server/Services/PetService.cs
    TWL.Shared/Services/IPetService.cs
    TWL.Shared/Domain/Requests/PetActionRequest.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
  </files>
  <action>
    1. Enforce rebirth eligibility policy so quest/evolution-eligible pets can rebirth while capturable pets are rejected.

    2. Extend `PetActionType` and session routing to support explicit pet rebirth requests with clear success/failure reasons.

    3. Preserve existing switch/dismiss/utility behavior while adding rebirth path without breaking compatibility.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Pet rebirth policy is server-enforced and reachable through explicit network action contracts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pet rebirth policy and evolution regression tests</name>
  <files>
    TWL.Tests/PetTests/PetRebirthPolicyTests.cs
    TWL.Tests/PetTests/PetRebirthEvolutionTests.cs
  </files>
  <action>
    1. Add eligibility tests for quest-pet allow and capturable-pet deny behavior.

    2. Add diminishing-schedule tests for repeated pet rebirth generations (`10/8/5`).

    3. Add evolution tests validating configured evolution transitions on successful rebirth.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~PetRebirthPolicyTests|FullyQualifiedName~PetRebirthEvolutionTests"`
  </verify>
  <done>
    Pet rebirth differentiation and evolution behavior are deterministic and regression-protected.
  </done>
</task>

</tasks>

<verification>
- [ ] Capturable pets are blocked from rebirth while quest/evolution-eligible pets can rebirth
- [ ] Pet rebirth bonus schedule follows `10/8/5`
- [ ] Pet rebirth action is routed through client session and pet service contracts
- [ ] Pet rebirth policy/evolution tests pass
</verification>

<success_criteria>
- PET-03 implemented with explicit eligibility differentiation
- PET-04 implemented with generation-based diminishing bonuses and evolution support
- Pet rebirth behavior is server-authoritative and test-backed
</success_criteria>

<output>
After completion, create `.planning/phases/06-rebirth-system/06-03-SUMMARY.md`
</output>

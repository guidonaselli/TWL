---
phase: 06-rebirth-system
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - TWL.Server/Simulation/Managers/RebirthManager.cs
  - TWL.Server/Simulation/Networking/ServerCharacter.cs
  - TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
  - TWL.Shared/Net/Payloads/LoginResponseDto.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Client/Presentation/Managers/PlayerCharacterData.cs
  - TWL.Client/Presentation/UI/UiGameplay.cs
  - TWL.Tests/Rebirth/CharacterRebirthRequirementTests.cs
  - TWL.Tests/Rebirth/RebirthPrestigeDisplayTests.cs
autonomous: true

must_haves:
  truths:
    - "Character rebirth enforces minimum level and optional quest/item prerequisites before allowing rebirth"
    - "Character keeps skills and equipped gear across rebirth and can continue using retained gear at level 1"
    - "Rebirth count is visible in character info/nameplate/HUD as prestige metadata"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/RebirthManager.cs"
      provides: "Eligibility checks for optional quest/item rebirth requirements and retention invariants"
      contains: "ValidateCharacterRebirthRequirements"
    - path: "TWL.Shared/Net/Payloads/LoginResponseDto.cs"
      provides: "Server-to-client rebirth prestige fields for character identity payloads"
      contains: "RebirthLevel"
    - path: "TWL.Client/Presentation/UI/UiGameplay.cs"
      provides: "Client HUD display of rebirth prestige next to level identity"
      contains: "Rebirth"
  key_links:
    - from: "TWL.Server/Simulation/Networking/ClientSession.cs"
      to: "TWL.Shared/Net/Payloads/LoginResponseDto.cs"
      via: "login and character-state responses include rebirth level from authoritative character state"
      pattern: "RebirthLevel"
    - from: "TWL.Shared/Net/Payloads/LoginResponseDto.cs"
      to: "TWL.Client/Presentation/Managers/PlayerCharacterData.cs"
      via: "payload field mapping hydrates client-side character prestige model"
      pattern: "RebirthLevel"
    - from: "TWL.Client/Presentation/Managers/PlayerCharacterData.cs"
      to: "TWL.Client/Presentation/UI/UiGameplay.cs"
      via: "HUD/nameplate reads rebirth level from player character data"
      pattern: "Rebirth"
---

<objective>
Implement rebirth eligibility enforcement and prestige visibility while preserving character build continuity after rebirth.

Purpose: This delivers REB-02, REB-03, and REB-04 using the transactional rebirth foundation from Plan 06-01.
Output: Rebirth requirement checks + payload/UI propagation for prestige display + retention and display regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rebirth-system/06-RESEARCH.md
@.planning/phases/06-rebirth-system/06-01-PLAN.md

@TWL.Server/Simulation/Managers/RebirthManager.cs
@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
@TWL.Shared/Net/Payloads/LoginResponseDto.cs
@TWL.Client/Presentation/Managers/PlayerCharacterData.cs
@TWL.Client/Presentation/UI/UiGameplay.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce rebirth prerequisites and retention invariants</name>
  <files>
    TWL.Server/Simulation/Managers/RebirthManager.cs
    TWL.Server/Simulation/Networking/ServerCharacter.cs
    TWL.Server/Simulation/Networking/Components/PlayerQuestComponent.cs
  </files>
  <action>
    1. Extend rebirth validation to enforce level 100 plus optional requirement gates (quest flag and/or required item).

    2. Explicitly preserve skill mastery and equipment ownership across rebirth and prevent post-rebirth gear lockout caused by level reset.

    3. Reuse existing quest/item state sources to avoid duplicating requirement systems.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Character rebirth eligibility and post-rebirth retention behavior are deterministic and server-authoritative.
  </done>
</task>

<task type="auto">
  <name>Task 2: Propagate rebirth prestige to client payloads and HUD/nameplate</name>
  <files>
    TWL.Shared/Net/Payloads/LoginResponseDto.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Client/Presentation/Managers/PlayerCharacterData.cs
    TWL.Client/Presentation/UI/UiGameplay.cs
  </files>
  <action>
    1. Add rebirth-level field to login/character payloads produced by server session handlers.

    2. Map rebirth-level field into client character data model.

    3. Render rebirth prestige in HUD/nameplate surfaces in a stable format (for example `Lv. 37 (R2)`).
  </action>
  <verify>
    `dotnet build TWL.Client/TWL.Client.csproj` and `dotnet build TWL.Server/TWL.Server.csproj` succeed.
  </verify>
  <done>
    Rebirth count is visible to players and remains in sync with server state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add requirement and prestige display regression tests</name>
  <files>
    TWL.Tests/Rebirth/CharacterRebirthRequirementTests.cs
    TWL.Tests/Rebirth/RebirthPrestigeDisplayTests.cs
  </files>
  <action>
    1. Add requirement tests validating rejection/acceptance for missing and satisfied optional quest/item gates.

    2. Add retention tests proving skills/equipment persist after rebirth and are still usable.

    3. Add payload/display tests proving rebirth level survives serialization and appears in client-facing character state.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CharacterRebirthRequirementTests|FullyQualifiedName~RebirthPrestigeDisplayTests"`
  </verify>
  <done>
    Rebirth prerequisites, retention invariants, and prestige visibility are test-backed.
  </done>
</task>

</tasks>

<verification>
- [ ] Optional rebirth prerequisites (quest/item) are enforced
- [ ] Skill trees and equipment are retained and usable after rebirth reset
- [ ] Rebirth level is included in server payloads and shown in client HUD/nameplate
- [ ] Requirement and display tests pass
</verification>

<success_criteria>
- REB-02 implemented with explicit eligibility checks
- REB-03 implemented with persisted and visible prestige metadata
- REB-04 implemented with regression-backed retention behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-rebirth-system/06-02-SUMMARY.md`
</output>

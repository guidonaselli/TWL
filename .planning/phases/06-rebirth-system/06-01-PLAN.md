---
phase: 06-rebirth-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TWL.Server/Simulation/Managers/IRebirthService.cs
  - TWL.Server/Simulation/Managers/RebirthManager.cs
  - TWL.Shared/Domain/DTO/RebirthDTOs.cs
  - TWL.Server/Persistence/PlayerSaveData.cs
  - TWL.Shared/Net/Network/Opcode.cs
  - TWL.Server/Simulation/Networking/ClientSession.cs
  - TWL.Server/Simulation/Program.cs
  - TWL.Tests/Rebirth/CharacterRebirthTransactionTests.cs
autonomous: true

must_haves:
  truths:
    - "Character rebirth at level 100+ resets level to 1 and grants permanent stat bonuses using 20/15/10/5 diminishing returns"
    - "Character rebirth executes atomically and does not leave partial state on failure"
    - "Character rebirth writes auditable history records for debugging and rollback analysis"
  artifacts:
    - path: "TWL.Server/Simulation/Managers/RebirthManager.cs"
      provides: "Server-authoritative character rebirth operation with formula and transactional safeguards"
      contains: "TryRebirthCharacter"
    - path: "TWL.Shared/Domain/DTO/RebirthDTOs.cs"
      provides: "Canonical request/response/history contracts for rebirth operations"
      contains: "CharacterRebirthRequest"
    - path: "TWL.Server/Persistence/PlayerSaveData.cs"
      provides: "Persistent rebirth counters and history records in save payload"
      contains: "RebirthHistory"
  key_links:
    - from: "TWL.Shared/Net/Network/Opcode.cs"
      to: "TWL.Server/Simulation/Networking/ClientSession.cs"
      via: "character rebirth opcodes dispatch into rebirth manager handlers"
      pattern: "CharacterRebirthRequest|CharacterRebirthResponse"
    - from: "TWL.Server/Simulation/Managers/RebirthManager.cs"
      to: "TWL.Server/Persistence/PlayerSaveData.cs"
      via: "successful and failed rebirth attempts produce auditable history entries"
      pattern: "RebirthHistory|OperationId"
---

<objective>
Implement character rebirth transactional foundation, including formula policy, atomic state mutation, persistence history, and network entry points.

Purpose: This delivers REB-01, REB-05, REB-06, and REB-07 as a secure base for all remaining rebirth functionality.
Output: Rebirth service + DTO contracts + opcode/session wiring + transaction and formula regression tests.
</objective>

<execution_context>
@~/.codex/get-shit-done/workflows/execute-plan.md
@~/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rebirth-system/06-RESEARCH.md

@TWL.Server/Simulation/Networking/ServerCharacter.cs
@TWL.Server/Persistence/PlayerSaveData.cs
@TWL.Server/Simulation/Networking/ClientSession.cs
@TWL.Server/Simulation/Program.cs
@TWL.Shared/Net/Network/Opcode.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rebirth domain service and diminishing-returns policy</name>
  <files>
    TWL.Server/Simulation/Managers/IRebirthService.cs
    TWL.Server/Simulation/Managers/RebirthManager.cs
    TWL.Shared/Domain/DTO/RebirthDTOs.cs
    TWL.Server/Persistence/PlayerSaveData.cs
  </files>
  <action>
    1. Add `IRebirthService` and `RebirthManager` with a server-authoritative `TryRebirthCharacter` operation.

    2. Implement explicit diminishing-return schedule for character rebirth stat grants:
       - rebirth 1: +20 per configured stat bucket
       - rebirth 2: +15
       - rebirth 3: +10
       - rebirth 4+: +5

    3. Extend persistence contracts with rebirth history records containing operation id, actor, old/new level, old/new rebirth count, stat deltas, timestamp, and result status.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj` and `dotnet build TWL.Shared/TWL.Shared.csproj` succeed.
  </verify>
  <done>
    Rebirth domain contracts exist with deterministic formula behavior and persistent rebirth history support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire character rebirth requests through opcode handlers and DI</name>
  <files>
    TWL.Shared/Net/Network/Opcode.cs
    TWL.Server/Simulation/Networking/ClientSession.cs
    TWL.Server/Simulation/Program.cs
  </files>
  <action>
    1. Add character rebirth request/response opcodes and payload handling in `ClientSession`.

    2. Register `IRebirthService`/`RebirthManager` in DI and inject into `ClientSession`.

    3. Ensure handler flow returns explicit rejection reasons (level gate, requirement gate, idempotency conflict, transaction failure) and no silent failures.
  </action>
  <verify>
    `dotnet build TWL.Server/TWL.Server.csproj`
  </verify>
  <done>
    Character rebirth is network-addressable and routed through server-authoritative manager logic.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add transactional and formula regression tests</name>
  <files>
    TWL.Tests/Rebirth/CharacterRebirthTransactionTests.cs
  </files>
  <action>
    1. Add tests covering level-100 gate, successful rebirth reset-to-level-1 behavior, and diminishing bonus schedule (`20/15/10/5`).

    2. Add failure-path tests proving no partial state mutation when rebirth fails mid-operation.

    3. Assert history/audit entries are created for successful and rejected attempts.
  </action>
  <verify>
    `dotnet test TWL.Tests/TWL.Tests.csproj --filter "FullyQualifiedName~CharacterRebirthTransactionTests"`
  </verify>
  <done>
    Character rebirth transactional safety and formula correctness are test-backed.
  </done>
</task>

</tasks>

<verification>
- [ ] Character rebirth uses `20/15/10/5` diminishing returns schedule
- [ ] Rebirth operation is atomic and rollback-safe
- [ ] Rebirth history/audit records are persisted with operation context
- [ ] Character rebirth handler is reachable via opcode path
</verification>

<success_criteria>
- REB-01 implemented with deterministic diminishing bonuses
- REB-05 and REB-06 implemented through transactional and auditable rebirth operations
- REB-07 implemented with explicit rebirth-schedule policy
</success_criteria>

<output>
After completion, create `.planning/phases/06-rebirth-system/06-01-SUMMARY.md`
</output>

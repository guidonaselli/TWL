# Design: Earth Skill Pack (T1 & T2) & System Refinements

## Context
This design covers the implementation of the Earth element skills (Physical, Magical, Support) and the necessary system refinements for Stacking, Resistance, and Auto-Battle heuristics.

## System Refinements

### 1. Stacking & Conflict Logic
- **Goal**: Prevent "buff soup" and ensure deterministic application of effects.
- **Fields**:
    - `StackingPolicy`: `NoStackOverwrite`, `RefreshDuration`, `StackUpToN`, `SeparateInstances`.
    - `ConflictGroup`: String identifier (e.g., "Buff_Def", "HardControl").
    - `Priority`: Integer (Higher value overrides lower).
- **Implementation**:
    - `StatusEngine.Apply` must respect these fields.
    - `NoStackOverwrite`: If conflict exists (Group or Tag/Param), replace if `New.Priority >= Old.Priority`.
    - `RefreshDuration`: Update `TurnsRemaining`. If `New.Value > Old.Value`, update `Value`.
    - `StackUpToN`: Increment stack count up to `MaxStacks`.

### 2. Cleanse & Dispel Logic
- **Goal**: Allow selective removal of effects based on tags or priority.
- **Changes**:
    - Update `CleanseDebuffs` and `DispelBuffs` in `ServerCombatant` to accept `allowedTags` and `maxPriority`.
    - `SkillEffect` for Cleanse/Dispel will use:
        - `Value`: Max Priority to remove.
        - `ResistanceTags`: List of tags to target (empty = all standard).
    - **Logic**:
        - If `ResistanceTags` is empty, target standard groups (DebuffStats, Seal, Burn / BuffStats, Shield).
        - If `ResistanceTags` has values, ONLY target effects with matching `ConflictGroup` or `Tag`.
        - Filter out effects where `Effect.Priority > Cleanse.Value`.

### 3. Auto-Battle Heuristics
- **Goal**: Deterministic, smart AI.
- **Priorities**:
    1.  **Survival**: Heal if Ally HP < `CriticalHpPercent`.
    2.  **Cleanse**: If Ally has Debuff/Seal.
    3.  **Dispel**: If Enemy has Buff/Shield.
    4.  **Control**: Seal Enemy if `SealResist < 100%` and not already Sealed.
    5.  **Buff**: Apply Buff if Ally doesn't have it (check ConflictGroup).
    6.  **Damage**: Weakest Enemy (Kill Confirm) or Best Damage Skill.
- **Constraints**:
    - `MinSpThreshold`: Don't use non-essential skills if SP is low.
    - `Cooldown`: Respect CD.

## Earth Skill Pack (Tier 1)

### 1. Rock Smash (Physical)
- **Concept**: Basic physical attack with a chance to Seal (stun/petrify).
- **Progression**:
    - Stage 1: 1.2x ATK, 15% Seal (1 turn).
    - Stage 2: 1.4x ATK, 15% Seal (1 turn).
    - Stage 3: 1.6x ATK, 15% Seal (1 turn).
- **Tags**: `Damage`, `Seal`.
- **Conflict**: Seal is `HardControl`.
- **Resistance**: `SealResist`.

### 2. Stone Bullet (Magical)
- **Concept**: Basic magic attack. Reliable damage.
- **Progression**:
    - Stage 1: 1.2x MAT.
    - Stage 2: 1.4x MAT.
    - Stage 3: 1.6x MAT.
- **Tags**: `Damage`.

### 3. Gaia's Protection (Support)
- **Concept**: Defensive buff. Increases DEF and SealResist.
- **Progression**:
    - Stage 1: +10 DEF, +20% SealResist (3 turns).
    - Stage 2: +15 DEF, +25% SealResist (3 turns).
    - Stage 3: +20 DEF, +30% SealResist (4 turns).
- **Tags**: `BuffStats`.
- **Conflict**: `Buff_Def`, `Buff_Resist`.
- **Stacking**: `RefreshDuration`.

## Earth Skill Pack (Tier 2) - *Implemented but out of daily scope, listed for context*

### 4. Boulder Crush (Physical T2)
- Heavy damage.

### 5. Rolling Stone (Magical T2)
- Row AoE.

### 6. Entangle (Support T2)
- Strong Seal (70% chance).

## Test Plan
1.  **Unit Tests**: `EarthSkillTests.cs`
    - Verify `RockSmash` applies damage and seal (mock RNG).
    - Verify `GaiasProtection` buffs stats and resists.
    - Verify `GaiasProtection` refreshes duration on re-cast.
    - Verify `GaiasProtection` does NOT stack with itself (ConflictGroup).
2.  **System Tests**:
    - `StatusEngineTests.cs`: Verify Priority logic for overwriting.
    - `CombatManagerTests.cs`: Verify `Cleanse` uses priority/tags correctly.
    - `AutoBattleManagerTests.cs`: Verify Heal priority and Seal avoidance on immune targets.
